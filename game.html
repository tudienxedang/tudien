<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªçc ti·∫øng x∆° ƒëƒÉng qua tr√≤ ch∆°i t∆∞∆°ng t√°c</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }
    
    * {
      box-sizing: border-box;
    }

    .card {
      perspective: 1000px;
      cursor: pointer;
    }

    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }

    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      font-weight: 500;
    }

    .card-front {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 36px;
    }

    .card-back {
      background: white;
      color: #1e3a8a;
      transform: rotateY(180deg);
      border: 3px solid #3b82f6;
      font-size: 14px;
    }

    .card.matched .card-back {
      background: #10b981;
      color: white;
      border-color: #059669;
    }

    .falling-word {
      position: absolute;
      padding: 10px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      color: white;
      min-width: 80px;
      text-align: center;
    }

    .falling-word:hover {
      transform: scale(1.05);
    }

    .basket-character {
      position: absolute;
      bottom: 10px;
      width: 80px;
      height: 100px;
      transition: left 0.1s linear;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .basket-body {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .basket-base {
      width: 70px;
      height: 25px;
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      border-radius: 8px 8px 0 0;
      margin-top: -10px;
    }

    .enemy {
      position: absolute;
      width: 70px;
      height: 90px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.3s;
    }

    .enemy-body {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .enemy-health-bar {
      width: 60px;
      height: 6px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 3px;
      margin-top: 4px;
      overflow: hidden;
    }

    .enemy-health-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      transition: width 0.3s;
    }

    .player-turret {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 140px;
      height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
    }

    .turret-head {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3b82f6 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      box-shadow: 0 8px 24px rgba(30, 58, 138, 0.7), 0 0 40px rgba(59, 130, 246, 0.4), inset 0 -10px 20px rgba(0, 0, 0, 0.3);
      border: 5px solid #60a5fa;
      position: relative;
      transition: transform 0.1s ease-out;
    }

    .turret-head::before {
      content: '';
      position: absolute;
      top: 15%;
      left: 20%;
      width: 30px;
      height: 30px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.6), transparent);
      border-radius: 50%;
      pointer-events: none;
    }

    .turret-head.shooting {
      animation: cannonShoot 0.35s ease-out;
    }

    @keyframes cannonShoot {
      0% { transform: scale(1); }
      25% { transform: scale(1.2) translateY(-8px); }
      50% { transform: scale(0.9) translateY(5px); }
      75% { transform: scale(1.05) translateY(-2px); }
      100% { transform: scale(1); }
    }

    .arrow {
      position: absolute;
      width: 30px;
      height: 30px;
      background: radial-gradient(circle, #fbbf24 0%, #f59e0b 50%, #ea580c 100%);
      border-radius: 50%;
      transition: all 0.02s linear;
      z-index: 100;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.8), 0 0 40px rgba(234, 88, 12, 0.4);
    }

    .arrow::before {
      content: 'üí•';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      animation: cannonballSpin 0.4s linear infinite;
    }

    @keyframes cannonballSpin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .arrow::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.5), transparent);
      top: 0;
      left: 0;
    }

    .arrow-trail {
      position: absolute;
      width: 15px;
      height: 15px;
      background: radial-gradient(circle, rgba(251, 191, 36, 0.6) 0%, rgba(234, 88, 12, 0.3) 50%, transparent 100%);
      border-radius: 50%;
      pointer-events: none;
      animation: fadeTrail 0.5s ease-out forwards;
    }

    @keyframes fadeTrail {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(2); }
    }

    .plant-plot {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .farmer-character {
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 40px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .pulse {
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .bounce {
      animation: bounce 0.6s ease-in-out infinite;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.3s ease-in-out;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .level-complete-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0);
      }
      to {
        transform: scale(1);
      }
    }

    .explosion {
      position: absolute;
      font-size: 48px;
      pointer-events: none;
      animation: explode 0.6s ease-out forwards;
    }

    @keyframes explode {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 1;
      }
      50% {
        transform: scale(1.5) rotate(180deg);
        opacity: 1;
      }
      100% {
        transform: scale(3) rotate(360deg);
        opacity: 0;
      }
    }

    @keyframes explodeParticle {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(var(--tx), var(--ty)) scale(0);
        opacity: 0;
      }
    }

    @keyframes sparkle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.15); }
    }

    .sparkle {
      animation: sparkle 1s ease-in-out infinite;
    }

    @keyframes shrink {
      0% { transform: scale(1); }
      100% { transform: scale(0.8); opacity: 0.6; }
    }

    .shrink {
      animation: shrink 0.4s ease-out forwards;
    }

    @keyframes grow {
      0% { transform: scale(0.8); }
      100% { transform: scale(1); }
    }

    .grow {
      animation: grow 0.4s ease-out forwards;
    }

    @keyframes basketSquash {
      0% { transform: scale(1, 1) translateY(0); }
      50% { transform: scale(1.15, 0.85) translateY(10px); }
      100% { transform: scale(1, 1) translateY(0); }
    }

    @keyframes wordAbsorb {
      0% { 
        transform: scale(1) translateY(0);
        opacity: 1;
      }
      50% {
        transform: scale(1.4) translateY(-15px) rotate(10deg);
        opacity: 1;
      }
      100% { 
        transform: scale(0.3) translateY(30px);
        opacity: 0;
      }
    }

    @keyframes impactRing {
      0% {
        transform: scale(0.5);
        opacity: 1;
      }
      100% {
        transform: scale(2.5);
        opacity: 0;
      }
    }

    .certificate-signature {
      font-family: 'Great Vibes', cursive;
      font-size: 36px;
      color: #1e3a8a;
    }

    @keyframes certificateFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .certificate-container {
      animation: certificateFadeIn 0.6s ease-out;
    }

    @keyframes sealRotate {
      0% { transform: rotate(0deg) scale(0); }
      60% { transform: rotate(360deg) scale(1.1); }
      100% { transform: rotate(360deg) scale(1); }
    }

    .certificate-seal {
      animation: sealRotate 0.8s ease-out 0.3s backwards;
    }

    .offline-indicator {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 12px 20px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
      z-index: 999;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideInLeft 0.3s ease-out;
    }

    @keyframes slideInLeft {
      from {
        transform: translateX(-400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .offline-dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    /* √Çm thanh controls */
    .sound-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }

    .sound-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s;
      border: 2px solid #3b82f6;
    }

    .sound-btn:hover {
      transform: scale(1.1);
      background: #f0f9ff;
    }

    .sound-btn.active {
      background: #3b82f6;
      color: white;
    }

    .sound-btn.muted {
      background: #ef4444;
      color: white;
      border-color: #dc2626;
    }

    /* Leaderboard improvements */
    .leaderboard-entry {
      transition: all 0.3s ease;
    }
    
    .leaderboard-entry:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    
    .rank-badge {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    .score-progress {
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      background: #e5e7eb;
    }
    
    .score-progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto bg-gradient-to-br from-blue-50 to-indigo-100"></div>
  <div id="offline-indicator" style="display: none;"></div>
  
  <!-- Sound Controls -->
  <div class="sound-controls" id="sound-controls" style="display: none;">
    <button class="sound-btn active" id="bgm-toggle" title="Nh·∫°c n·ªÅn">üéµ</button>
    <button class="sound-btn active" id="sfx-toggle" title="Hi·ªáu ·ª©ng √¢m thanh">üîä</button>
  </div>

  <script>
    // C·∫•u h√¨nh Google Sheets - CH·ªà d√πng cho c√¢u h·ªèi, kh√¥ng d√πng cho ƒëi·ªÉm s·ªë
    const API_KEY = 'AIzaSyD757jS4SLR7-EzrPgrW9WrLQeD2DQExHw';
    const SPREADSHEET_ID = '1Z59pDBu_tGwlYqUeS1-VJLpcHozp7LbxnC_-qhT3iHs';
    const RANGE = 'Game!A3:T';

    // D·ªØ li·ªáu m·∫´u backup
    const MOCK_DATA = {
      game1: [
        ['Con voi', 'Chi√™ng', 'Chu·ªôt', 'G√†', 'Ch√≥'],
        ['M√®o', 'Meo', 'Ch√≥', 'G√†', 'V·ªãt'],
        ['Ch√≥', 'Aso', 'M√®o', 'G√†', 'V·ªãt'],
        ['G√†', 'Manuk', 'Ch√≥', 'M√®o', 'V·ªãt'],
        ['N∆∞·ªõc', 'Dak', 'L·ª≠a', 'ƒê·∫•t', 'Gi√≥'],
        ['M·∫π', 'M√™', 'B·ªë', 'Con', 'Anh'],
        ['T·ªët', 'T√¥ch', 'X·∫•u', 'ƒê·∫πp', 'To'],
        ['M·ªôt', 'Mu√¥i', 'Hai', 'Ba', 'B·ªën'],
        ['Tr·ªùi', 'Mu√¢', 'ƒê·∫•t', 'N∆∞·ªõc', 'L·ª≠a'],
        ['Y√™u', 'M∆° gu√¥l', 'Gh√©t', 'Th∆∞∆°ng', 'Nh·ªõ']
      ],
      game2: [
        ['N∆∞·ªõc', 'Dak', 'L·ª≠a', 'ƒê·∫•t', 'Gi√≥'],
        ['L·ª≠a', 'Apui', 'N∆∞·ªõc', 'ƒê·∫•t', 'Gi√≥'],
        ['Tr·ªùi', 'Mu√¢', 'ƒê·∫•t', 'N∆∞·ªõc', 'Gi√≥'],
        ['ƒÇn c∆°m', 'Sa ∆°i', 'U·ªëng n∆∞·ªõc', 'Ng·ªß', 'ƒêi'],
        ['T·ªët', 'T√¥ch', 'X·∫•u', 'ƒê·∫πp', 'To'],
        ['M·∫π', 'M√™', 'B·ªë', 'Con', 'Anh'],
        ['Con voi', 'Chi√™ng', 'Chu·ªôt', 'G√†', 'Ch√≥'],
        ['Nh√†', 'H∆°m', 'R·ª´ng', 'N√∫i', 'S√¥ng'],
        ['Y√™u', 'M∆° gu√¥l', 'Gh√©t', 'Th∆∞∆°ng', 'Nh·ªõ'],
        ['C√¢y', 'Ka y√¥ng', 'Hoa', 'L√°', 'Qu·∫£']
      ],
      game3: [
        ['Nh√†', 'H∆°m', 'R·ª´ng', 'N√∫i', 'S√¥ng'],
        ['R·ª´ng', 'Bri', 'Nh√†', 'N√∫i', 'Bi·ªÉn'],
        ['N√∫i', 'Gunung', 'R·ª´ng', 'Bi·ªÉn', 'S√¥ng'],
        ['ƒÇn c∆°m', 'Sa ∆°i', 'U·ªëng n∆∞·ªõc', 'Ng·ªß', 'ƒêi'],
        ['M·∫π', 'M√™', 'B·ªë', 'Con', 'Anh'],
        ['T·ªët', 'T√¥ch', 'X·∫•u', 'ƒê·∫πp', 'To'],
        ['Con voi', 'Chi√™ng', 'Chu·ªôt', 'G√†', 'Ch√≥'],
        ['N∆∞·ªõc', 'Dak', 'L·ª≠a', 'ƒê·∫•t', 'Gi√≥'],
        ['Y√™u', 'M∆° gu√¥l', 'Gh√©t', 'Th∆∞∆°ng', 'Nh·ªõ'],
        ['C√¢y', 'Ka y√¥ng', 'Hoa', 'L√°', 'Qu·∫£']
      ],
      game4: [
        ['M·ªôt', 'Mu√¥i', 'Hai', 'Ba', 'B·ªën'],
        ['Hai', 'Bar', 'M·ªôt', 'Ba', 'B·ªën'],
        ['Ba', 'P∆°i', 'M·ªôt', 'Hai', 'B·ªën'],
        ['B·ªën', 'Pan', 'M·ªôt', 'Hai', 'Ba'],
        ['NƒÉm', 'Th∆°m', 'M·ªôt', 'Hai', 'Ba'],
        ['S√°u', '∆†m', 'M·ªôt', 'Hai', 'Ba'],
        ['B·∫£y', 'Tuh', 'M·ªôt', 'Hai', 'Ba'],
        ['T√°m', 'Tam', 'M·ªôt', 'Hai', 'Ba'],
        ['Ch√≠n', 'Chin', 'M·ªôt', 'Hai', 'Ba'],
        ['M∆∞·ªùi', 'Pluh', 'M·ªôt', 'Hai', 'Ba']
      ]
    };

    // State to√†n c·ª•c
    let currentUser = null;
    let gameData = {
      game1: [],
      game2: [],
      game3: [],
      game4: []
    };
    let currentScreen = 'login';
    let isOnline = navigator.onLine;

    // Game states
    let game1State = {
      level: 1,
      cards: [],
      flippedCards: [],
      matchedPairs: 0,
      moves: 0,
      totalPairs: 0,
      totalScore: 0
    };

    let game2State = {
      score: 0,
      level: 1,
      questionsAnswered: 0,
      currentQuestion: null,
      fallingWords: [],
      basketX: 0,
      gameLoop: null,
      questionIndex: 0,
      lives: 3,
      combo: 0,
      maxCombo: 0
    };

    let game3State = {
      score: 0,
      level: 1,
      questionsAnswered: 0,
      enemies: [],
      currentQuestion: null,
      gameLoop: null,
      questionIndex: 0,
      lives: 3,
      combo: 0,
      maxCombo: 0
    };

    let game4State = {
      level: 1,
      harvestCount: 0,
      totalScore: 0,
      plots: [
        { stage: 0 },
        { stage: 0 },
        { stage: 0 },
        { stage: 0 }
      ],
      currentQuestion: null,
      selectedPlot: null,
      combo: 0,
      maxCombo: 0
    };

    // ========== BI·∫æN C·ªú QUAN TR·ªåNG: Theo d√µi tr·∫°ng th√°i kh·ªüi t·∫°o game ==========
    let isGame4Initialized = false; // QUAN TR·ªåNG: Theo d√µi xem game 4 ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o ch∆∞a

    // ========== H·ªÜ TH·ªêNG √ÇM THANH ==========
    let audioContext;
    let bgmEnabled = localStorage.getItem('xedang_bgm') !== 'false';
    let sfxEnabled = localStorage.getItem('xedang_sfx') !== 'false';
    let bgmSource;
    let bgmPlaying = false;
    let currentBGM = null;

    // Kh·ªüi t·∫°o Audio Context
    function initAudio() {
      if (!audioContext) {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          console.log('AudioContext initialized');
        } catch (e) {
          console.warn('Web Audio API not supported:', e);
        }
      }
    }

    // T·∫°o √¢m thanh ƒë∆°n gi·∫£n
    function createBeep(frequency, duration, type = 'sine', volume = 0.3) {
      if (!audioContext || !sfxEnabled) return null;
      
      try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = type;
        
        gainNode.gain.value = volume;
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + duration);
        
        return oscillator;
      } catch (e) {
        console.warn('Error creating beep:', e);
        return null;
      }
    }

    // Hi·ªáu ·ª©ng √¢m thanh cho c√°c s·ª± ki·ªán game
    const SoundEffects = {
      // Game 1: L·∫≠t th·∫ª
      flipCard: () => createBeep(523.25, 0.1, 'sine', 0.2),
      matchSuccess: () => {
        if (!audioContext || !sfxEnabled) return;
        createBeep(659.25, 0.1, 'sine', 0.3);
        setTimeout(() => createBeep(783.99, 0.1, 'sine', 0.3), 100);
        setTimeout(() => createBeep(1046.50, 0.2, 'sine', 0.3), 200);
      },
      matchFail: () => createBeep(220, 0.3, 'sine', 0.2),
      
      // Game 2: M∆∞a t·ª´ v·ª±ng
      wordCaught: () => {
        if (!audioContext || !sfxEnabled) return;
        createBeep(784, 0.1, 'sine', 0.3);
        setTimeout(() => createBeep(1047, 0.15, 'sine', 0.3), 50);
      },
      wordMissed: () => createBeep(330, 0.3, 'sawtooth', 0.2),
      basketMove: () => createBeep(440, 0.05, 'sine', 0.1),
      levelUpGame2: () => {
        if (!audioContext || !sfxEnabled) return;
        createBeep(523, 0.1);
        setTimeout(() => createBeep(659, 0.1), 100);
        setTimeout(() => createBeep(784, 0.1), 200);
        setTimeout(() => createBeep(1047, 0.3), 300);
      },
      
      // Game 3: B·∫£o v·ªá c·ª© ƒëi·ªÉm
      shoot: () => createBeep(880, 0.1, 'square', 0.2),
      enemyHit: () => createBeep(587, 0.1, 'sine', 0.3),
      enemyDestroy: () => {
        if (!audioContext || !sfxEnabled) return;
        createBeep(440, 0.1, 'sawtooth', 0.4);
        setTimeout(() => createBeep(330, 0.2, 'sawtooth', 0.3), 100);
      },
      enemyPass: () => createBeep(220, 0.5, 'sine', 0.3),
      
      // Game 4: N√¥ng tr·∫°i s·ªë
      plantSeed: () => createBeep(659, 0.2, 'sine', 0.2),
      growPlant: () => {
        if (!audioContext || !sfxEnabled) return;
        createBeep(523, 0.1);
        setTimeout(() => createBeep(659, 0.1), 100);
      },
      harvest: () => {
        if (!audioContext || !sfxEnabled) return;
        createBeep(784, 0.1);
        setTimeout(() => createBeep(1047, 0.1), 80);
        setTimeout(() => createBeep(1318, 0.2), 160);
      },
      wrongAnswer: () => createBeep(220, 0.3, 'sawtooth', 0.2),
      
      // Chung
      buttonClick: () => createBeep(440, 0.05, 'sine', 0.1),
      correctAnswer: () => {
        if (!audioContext || !sfxEnabled) return;
        createBeep(523, 0.1);
        setTimeout(() => createBeep(659, 0.1), 100);
        setTimeout(() => createBeep(784, 0.2), 200);
      },
      wrongAnswerGeneral: () => createBeep(220, 0.3, 'sawtooth', 0.2),
      levelComplete: () => {
        if (!audioContext || !sfxEnabled) return;
        createBeep(523, 0.1);
        setTimeout(() => createBeep(659, 0.1), 100);
        setTimeout(() => createBeep(784, 0.1), 200);
        setTimeout(() => createBeep(1047, 0.1), 300);
        setTimeout(() => createBeep(1318, 0.3), 400);
      },
      gameOver: () => {
        if (!audioContext || !sfxEnabled) return;
        createBeep(220, 0.3, 'sine', 0.3);
        setTimeout(() => createBeep(196, 0.3, 'sine', 0.3), 300);
        setTimeout(() => createBeep(165, 0.5, 'sine', 0.3), 600);
      },
      achievement: () => {
        if (!audioContext || !sfxEnabled) return;
        createBeep(1047, 0.1);
        setTimeout(() => createBeep(1318, 0.1), 100);
        setTimeout(() => createBeep(1568, 0.1), 200);
        setTimeout(() => createBeep(2093, 0.3), 300);
      }
    };

    // Nh·∫°c n·ªÅn cho c√°c game
    function playBackgroundMusic(gameType) {
      if (!audioContext || !bgmEnabled || bgmPlaying) return;
      
      try {
        // D·ª´ng nh·∫°c c≈© n·∫øu c√≥
        if (bgmSource) {
          bgmSource.stop();
          bgmSource = null;
        }
        
        currentBGM = gameType;
        bgmSource = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        bgmSource.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // T·∫ßn s·ªë v√† ki·ªÉu nh·∫°c kh√°c nhau cho t·ª´ng game
        switch(gameType) {
          case 'game1':
            bgmSource.frequency.value = 220;
            bgmSource.type = 'sine';
            break;
          case 'game2':
            bgmSource.frequency.value = 294;
            bgmSource.type = 'triangle';
            break;
          case 'game3':
            bgmSource.frequency.value = 330;
            bgmSource.type = 'sawtooth';
            break;
          case 'game4':
            bgmSource.frequency.value = 196;
            bgmSource.type = 'sine';
            break;
          default:
            bgmSource.frequency.value = 262;
            bgmSource.type = 'sine';
        }
        
        // T·∫°o hi·ªáu ·ª©ng nh·∫•n nh√°
        const now = audioContext.currentTime;
        gainNode.gain.setValueAtTime(0.05, now);
        gainNode.gain.exponentialRampToValueAtTime(0.03, now + 2);
        
        bgmSource.start();
        bgmPlaying = true;
        
        // L·∫∑p l·∫°i √¢m thanh
        bgmSource.onended = () => {
          if (bgmPlaying && currentScreen.includes('game')) {
            playBackgroundMusic(currentBGM);
          }
        };
        
      } catch (e) {
        console.warn('Error playing background music:', e);
      }
    }

    function stopBackgroundMusic() {
      if (bgmSource) {
        bgmSource.stop();
        bgmSource = null;
      }
      bgmPlaying = false;
      currentBGM = null;
    }

    function toggleBGM() {
      bgmEnabled = !bgmEnabled;
      localStorage.setItem('xedang_bgm', bgmEnabled);
      
      const btn = document.getElementById('bgm-toggle');
      if (bgmEnabled) {
        btn.classList.remove('muted');
        btn.classList.add('active');
        if (currentScreen.includes('game')) {
          playBackgroundMusic(currentScreen);
        }
      } else {
        btn.classList.remove('active');
        btn.classList.add('muted');
        stopBackgroundMusic();
      }
    }

    function toggleSFX() {
      sfxEnabled = !sfxEnabled;
      localStorage.setItem('xedang_sfx', sfxEnabled);
      
      const btn = document.getElementById('sfx-toggle');
      if (sfxEnabled) {
        btn.classList.remove('muted');
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
        btn.classList.add('muted');
      }
      
      // Ph√°t √¢m thanh x√°c nh·∫≠n
      if (sfxEnabled) {
        SoundEffects.buttonClick();
      }
    }

    function showSoundControls() {
      const controls = document.getElementById('sound-controls');
      if (controls) {
        controls.style.display = 'flex';
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
        const bgmBtn = document.getElementById('bgm-toggle');
        const sfxBtn = document.getElementById('sfx-toggle');
        
        if (bgmEnabled) {
          bgmBtn.classList.add('active');
          bgmBtn.classList.remove('muted');
        } else {
          bgmBtn.classList.add('muted');
          bgmBtn.classList.remove('active');
        }
        
        if (sfxEnabled) {
          sfxBtn.classList.add('active');
          sfxBtn.classList.remove('muted');
        } else {
          sfxBtn.classList.add('muted');
          sfxBtn.classList.remove('active');
        }
      }
    }

    // Config m·∫∑c ƒë·ªãnh cho Element SDK
    const defaultConfig = {
      app_title: 'H·ªçc Ti·∫øng X√™ ƒêƒÉng',
      welcome_message: 'Ch√†o m·ª´ng ƒë·∫øn v·ªõi',
      game1_name: 'L·∫≠t √î Ghi Nh·ªõ',
      game2_name: 'M∆∞a T·ª´ V·ª±ng',
      game3_name: 'B·∫£o V·ªá C·ª© ƒêi·ªÉm',
      game4_name: 'N√¥ng Tr·∫°i S·ªë',
      certificate_title: 'CH·ª®NG NH·∫¨N HO√ÄN TH√ÄNH',
      certificate_text: 'ƒê√£ ho√†n th√†nh xu·∫•t s·∫Øc kh√≥a h·ªçc',
      primary_color: '#3b82f6',
      secondary_color: '#8b5cf6',
      background_color: '#eff6ff',
      text_color: '#1e3a8a',
      success_color: '#10b981'
    };

    // Theo d√µi tr·∫°ng th√°i m·∫°ng
    window.addEventListener('online', () => {
      isOnline = true;
      updateOfflineIndicator();
      fetchData();
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      updateOfflineIndicator();
    });

    function updateOfflineIndicator() {
      const indicator = document.getElementById('offline-indicator');
      if (!indicator) return;

      if (!isOnline) {
        const offlineTimestamp = localStorage.getItem('xedang_offline_timestamp');
        const lastUpdate = offlineTimestamp ? new Date(parseInt(offlineTimestamp)).toLocaleString('vi-VN') : 'Ch∆∞a c√≥';
        
        indicator.className = 'offline-indicator';
        indicator.innerHTML = `
          <div class="offline-dot" style="background: #f59e0b;"></div>
          <div>
            <div style="font-size: 12px;">üìµ Ch·∫ø ƒë·ªô Offline</div>
            <div style="font-size: 10px; opacity: 0.8;">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${lastUpdate}</div>
          </div>
        `;
        indicator.style.display = 'flex';
      } else {
        const offlineTimestamp = localStorage.getItem('xedang_offline_timestamp');
        const lastUpdate = offlineTimestamp ? new Date(parseInt(offlineTimestamp)).toLocaleString('vi-VN') : 'M·ªõi';
        
        indicator.className = 'offline-indicator';
        indicator.innerHTML = `
          <div class="offline-dot"></div>
          <div>
            <div style="font-size: 12px;">üì∂ Online</div>
            <div style="font-size: 10px; opacity: 0.8;">D·ªØ li·ªáu: ${lastUpdate}</div>
          </div>
        `;
        indicator.style.display = 'flex';
        
        setTimeout(() => {
          indicator.style.display = 'none';
        }, 3000);
      }
    }

    // Fetch d·ªØ li·ªáu t·ª´ Google Sheets v·ªõi offline support
    async function fetchData() {
      // T·∫£i d·ªØ li·ªáu offline tr∆∞·ªõc
      const offlineData = localStorage.getItem('xedang_offline_data');
      
      if (offlineData) {
        try {
          gameData = JSON.parse(offlineData);
        } catch (e) {
          gameData = MOCK_DATA;
        }
      } else {
        gameData = MOCK_DATA;
      }

      // N·∫øu online, th·ª≠ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi
      if (isOnline) {
        try {
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
          const response = await fetch(url, { 
            method: 'GET',
            signal: AbortSignal.timeout(10000) // 10s timeout
          });
          
          const data = await response.json();
          
          if (data.values && data.values.length > 0) {
            gameData.game1 = data.values.map(row => [
              row[0] || '', row[1] || '', row[2] || '', row[3] || '', row[4] || ''
            ]).filter(row => row[0] && row[1]);
            
            gameData.game2 = data.values.map(row => [
              row[5] || '', row[6] || '', row[7] || '', row[8] || '', row[9] || ''
            ]).filter(row => row[0] && row[1]);
            
            gameData.game3 = data.values.map(row => [
              row[10] || '', row[11] || '', row[12] || '', row[13] || '', row[14] || ''
            ]).filter(row => row[0] && row[1]);
            
            gameData.game4 = data.values.map(row => [
              row[15] || '', row[16] || '', row[17] || '', row[18] || '', row[19] || ''
            ]).filter(row => row[0] && row[1]);

            // L∆∞u d·ªØ li·ªáu offline
            localStorage.setItem('xedang_offline_data', JSON.stringify(gameData));
            localStorage.setItem('xedang_offline_timestamp', Date.now().toString());
            
            showToast('üì∂ ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi t·ª´ server!', 'success');
            updateOfflineIndicator();
          }
        } catch (error) {
          console.error('Error fetching online data:', error);
          // Kh√¥ng hi·ªÉn th·ªã l·ªói n·∫øu ƒë√£ c√≥ d·ªØ li·ªáu offline
          if (!offlineData) {
            localStorage.setItem('xedang_offline_data', JSON.stringify(MOCK_DATA));
            localStorage.setItem('xedang_offline_timestamp', Date.now().toString());
          }
        }
      }
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // ========== H·ªÜ TH·ªêNG L∆ØU ƒêI·ªÇM C·∫¢I THI·ªÜN ==========
    
    // LocalStorage helpers
    function saveUser(username) {
      const users = JSON.parse(localStorage.getItem('xedang_users') || '{}');
      if (!users[username]) {
        users[username] = {
          name: username,
          level: 1,
          totalScore: 0,
          bestScore: 0,
          gamesPlayed: 0,
          certificates: [],
          gameScores: {
            game1: [],
            game2: [],
            game3: [],
            game4: []
          },
          lastPlayed: Date.now(),
          joinedDate: new Date().toISOString()
        };
      }
      currentUser = users[username];
      localStorage.setItem('xedang_users', JSON.stringify(users));
      localStorage.setItem('xedang_current_user', username);
    }

    function loadUser() {
      const username = localStorage.getItem('xedang_current_user');
      if (username) {
        const users = JSON.parse(localStorage.getItem('xedang_users') || '{}');
        currentUser = users[username];
        
        // N·∫øu user c≈© kh√¥ng c√≥ c·∫•u tr√∫c m·ªõi, n√¢ng c·∫•p c·∫•u tr√∫c
        if (currentUser && !currentUser.gameScores) {
          currentUser.gameScores = {
            game1: [],
            game2: [],
            game3: [],
            game4: []
          };
          currentUser.bestScore = currentUser.totalScore || 0;
          currentUser.lastPlayed = Date.now();
          currentUser.joinedDate = currentUser.joinedDate || new Date().toISOString();
          
          // L∆∞u l·∫°i
          users[username] = currentUser;
          localStorage.setItem('xedang_users', JSON.stringify(users));
        }
        
        return true;
      }
      return false;
    }

    // H√†m c·∫≠p nh·∫≠t ƒëi·ªÉm - S·ª¨A L·ªñI: X√≥a h√†m c≈©, ch·ªâ gi·ªØ h√†m m·ªõi
    function updateUserScore(gameType, score, levelCompleted, sessionScore = 0) {
      const users = JSON.parse(localStorage.getItem('xedang_users') || '{}');
      
      if (currentUser && users[currentUser.name]) {
        const user = users[currentUser.name];
        
        // T·∫°o c·∫•u tr√∫c l∆∞u ƒëi·ªÉm theo game n·∫øu ch∆∞a c√≥
        if (!user.gameScores) user.gameScores = {};
        if (!user.gameScores[gameType]) user.gameScores[gameType] = [];
        
        // L∆∞u ƒëi·ªÉm c·ªßa session hi·ªán t·∫°i
        const gameSession = {
          score: score,
          level: levelCompleted,
          timestamp: Date.now(),
          date: new Date().toLocaleDateString('vi-VN'),
          time: new Date().toLocaleTimeString('vi-VN'),
          sessionScore: sessionScore,
          isFinal: levelCompleted >= 5
        };
        
        user.gameScores[gameType].push(gameSession);
        
        // Gi·ªØ t·ªëi ƒëa 20 session m·ªói game
        if (user.gameScores[gameType].length > 20) {
          user.gameScores[gameType] = user.gameScores[gameType].slice(-20);
        }
        
        // T√≠nh ƒëi·ªÉm cao nh·∫•t cho game n√†y
        const gameBestScore = Math.max(...user.gameScores[gameType].map(s => s.score));
        
        // T√≠nh t·ªïng ƒëi·ªÉm t·∫•t c·∫£ game
        let totalAllGames = 0;
        Object.values(user.gameScores).forEach(gameScores => {
          if (Array.isArray(gameScores) && gameScores.length > 0) {
            const gameTotal = gameScores.reduce((sum, session) => sum + session.score, 0);
            totalAllGames += gameTotal;
          }
        });
        
        // C·∫≠p nh·∫≠t th√¥ng tin user
        user.totalScore = totalAllGames;
        user.bestScore = Math.max(user.bestScore || 0, gameBestScore);
        user.gamesPlayed += 1;
        user.lastPlayed = Date.now();
        
        // T√≠nh level d·ª±a tr√™n t·ªïng ƒëi·ªÉm
        user.level = Math.min(10, Math.floor(user.totalScore / 500) + 1);
        
        // L∆∞u l·∫°i
        localStorage.setItem('xedang_users', JSON.stringify(users));
        currentUser = user;
        
        console.log(`ƒê√£ l∆∞u ƒëi·ªÉm: ${score} cho game ${gameType}, T·ªïng ƒëi·ªÉm: ${user.totalScore}`);
        
        // ƒê·ªìng b·ªô l√™n Google Sheets n·∫øu ƒë∆∞·ª£c b·∫≠t
        if (SCORE_SYNC_CONFIG.enabled && SCORE_SYNC_CONFIG.sheetId && SCORE_SYNC_CONFIG.apiKey) {
          syncScoreToGoogleSheet(currentUser.name, score, gameType, levelCompleted);
        }
        
        return user;
      }
      return null;
    }

    // H√†m l·∫•y b·∫£ng x·∫øp h·∫°ng
    function getLeaderboard() {
      const users = JSON.parse(localStorage.getItem('xedang_users') || '{}');
      
      const leaderboard = Object.values(users).map(user => {
        // T√≠nh ƒëi·ªÉm trung b√¨nh m·ªói game
        let avgScorePerGame = 0;
        let gamesWithScores = 0;
        
        if (user.gameScores) {
          Object.values(user.gameScores).forEach(gameSessions => {
            if (Array.isArray(gameSessions) && gameSessions.length > 0) {
              const gameTotal = gameSessions.reduce((sum, session) => sum + session.score, 0);
              avgScorePerGame += gameTotal / gameSessions.length;
              gamesWithScores++;
            }
          });
        }
        
        avgScorePerGame = gamesWithScores > 0 ? avgScorePerGame / gamesWithScores : 0;
        
        return {
          name: user.name,
          totalScore: user.totalScore || 0,
          bestScore: user.bestScore || 0,
          level: user.level || 1,
          gamesPlayed: user.gamesPlayed || 0,
          avgScorePerGame: avgScorePerGame,
          lastPlayed: user.lastPlayed || 0,
          joinedDate: user.joinedDate || new Date().toISOString()
        };
      });
      
      // S·∫Øp x·∫øp theo ti√™u ch√≠: totalScore > bestScore > level > lastPlayed
      leaderboard.sort((a, b) => {
        if (b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
        if (b.bestScore !== a.bestScore) return b.bestScore - a.bestScore;
        if (b.level !== a.level) return b.level - a.level;
        return b.lastPlayed - a.lastPlayed;
      });
      
      return leaderboard.slice(0, 10); // Top 10
    }

    // H√†m l·∫•y rank c·ªßa ng∆∞·ªùi ch∆°i hi·ªán t·∫°i
    function getCurrentUserRank() {
      const leaderboard = getLeaderboard();
      const currentIndex = leaderboard.findIndex(user => user.name === currentUser.name);
      return currentIndex >= 0 ? currentIndex + 1 : null;
    }

    // H√†m l·∫•y th·ªëng k√™ chi ti·∫øt cho user
    function getUserStats(username) {
      const users = JSON.parse(localStorage.getItem('xedang_users') || '{}');
      const user = users[username];
      
      if (!user) return null;
      
      const stats = {
        name: user.name,
        level: user.level || 1,
        totalScore: user.totalScore || 0,
        bestScore: user.bestScore || 0,
        gamesPlayed: user.gamesPlayed || 0,
        certificatesCount: (user.certificates || []).length,
        lastPlayed: user.lastPlayed ? new Date(user.lastPlayed).toLocaleDateString('vi-VN') : 'Ch∆∞a ch∆°i',
        joinedDate: user.joinedDate ? new Date(user.joinedDate).toLocaleDateString('vi-VN') : 'M·ªõi'
      };
      
      // Th·ªëng k√™ theo game
      if (user.gameScores) {
        stats.gameStats = {};
        Object.keys(user.gameScores).forEach(gameType => {
          const sessions = user.gameScores[gameType] || [];
          if (sessions.length > 0) {
            const totalScore = sessions.reduce((sum, session) => sum + session.score, 0);
            const bestScore = Math.max(...sessions.map(s => s.score));
            const avgScore = totalScore / sessions.length;
            const lastPlayed = sessions.length > 0 ? 
              new Date(sessions[sessions.length - 1].timestamp).toLocaleDateString('vi-VN') : 'Ch∆∞a ch∆°i';
            
            stats.gameStats[gameType] = {
              playCount: sessions.length,
              totalScore: totalScore,
              bestScore: bestScore,
              avgScore: avgScore.toFixed(1),
              lastPlayed: lastPlayed
            };
          }
        });
      }
      
      return stats;
    }

    function saveCertificate(gameName, score, level) {
      const users = JSON.parse(localStorage.getItem('xedang_users') || '{}');
      if (currentUser && users[currentUser.name]) {
        if (!users[currentUser.name].certificates) {
          users[currentUser.name].certificates = [];
        }
        
        const certificate = {
          gameName: gameName,
          score: score,
          level: level,
          date: new Date().toLocaleDateString('vi-VN'),
          timestamp: Date.now()
        };
        
        users[currentUser.name].certificates.push(certificate);
        currentUser = users[currentUser.name];
        localStorage.setItem('xedang_users', JSON.stringify(users));
      }
    }

    // ========== CH·ª®C NƒÇNG ƒê·ªíNG B·ªò GOOGLE SHEETS ==========
    
    // C·∫•u h√¨nh cho ƒë·ªìng b·ªô ƒëi·ªÉm
    const SCORE_SYNC_CONFIG = {
      enabled: false,
      sheetId: '',
      apiKey: ''
    };

    // H√†m ƒë·ªìng b·ªô ƒëi·ªÉm l√™n Google Sheets
    async function syncScoreToGoogleSheet(username, score, gameType, level) {
      if (!SCORE_SYNC_CONFIG.enabled || !SCORE_SYNC_CONFIG.sheetId || !SCORE_SYNC_CONFIG.apiKey) {
        return false;
      }
      
      if (!isOnline) {
        // L∆∞u v√†o queue n·∫øu offline
        const pendingSync = JSON.parse(localStorage.getItem('xedang_pending_sync') || '[]');
        pendingSync.push({
          username, score, gameType, level, timestamp: Date.now()
        });
        localStorage.setItem('xedang_pending_sync', JSON.stringify(pendingSync));
        return false;
      }
      
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SCORE_SYNC_CONFIG.sheetId}/values/Leaderboard!A:E:append?valueInputOption=USER_ENTERED&key=${SCORE_SYNC_CONFIG.apiKey}`;
        
        const data = {
          values: [[
            new Date().toISOString(),
            username,
            score,
            gameType,
            level
          ]]
        };
        
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          return true;
        } else {
          throw new Error('L·ªói ƒë·ªìng b·ªô');
        }
      } catch (error) {
        console.error('L·ªói ƒë·ªìng b·ªô ƒëi·ªÉm:', error);
        return false;
      }
    }

    // H√†m ƒë·ªìng b·ªô t·∫•t c·∫£ ƒëi·ªÉm ƒëang ch·ªù
    async function syncPendingScores() {
      if (!isOnline) return;
      
      const pendingSync = JSON.parse(localStorage.getItem('xedang_pending_sync') || '[]');
      if (pendingSync.length === 0) return;
      
      for (const item of pendingSync) {
        await syncScoreToGoogleSheet(item.username, item.score, item.gameType, item.level);
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      // X√≥a sau khi ƒë·ªìng b·ªô xong
      localStorage.removeItem('xedang_pending_sync');
    }

    // T·∫£i c·∫•u h√¨nh ƒë·ªìng b·ªô khi kh·ªüi ƒë·ªông
    function loadSyncConfig() {
      try {
        const savedConfig = localStorage.getItem('xedang_sync_config');
        if (savedConfig) {
          const config = JSON.parse(savedConfig);
          SCORE_SYNC_CONFIG.sheetId = config.sheetId || '';
          SCORE_SYNC_CONFIG.apiKey = config.apiKey || '';
          SCORE_SYNC_CONFIG.enabled = config.enabled || false;
        }
      } catch (error) {
        console.error('L·ªói t·∫£i c·∫•u h√¨nh ƒë·ªìng b·ªô:', error);
      }
    }

    // ========== T√çNH NƒÇNG T·ª∞ ƒê·ªòNG L∆ØU TI·∫æN TR√åNH ==========
    let autoSaveInterval = null;

    function startAutoSave(gameType, getStateFunc) {
      if (autoSaveInterval) clearInterval(autoSaveInterval);
      
      autoSaveInterval = setInterval(() => {
        const state = getStateFunc();
        const users = JSON.parse(localStorage.getItem('xedang_users') || '{}');
        
        if (currentUser && users[currentUser.name]) {
          users[currentUser.name].tempProgress = {
            gameType: gameType,
            state: JSON.parse(JSON.stringify(state)),
            timestamp: Date.now()
          };
          localStorage.setItem('xedang_users', JSON.stringify(users));
        }
      }, 30000);
    }

    function stopAutoSave() {
      if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
      }
    }

    // ========== H√ÄM L∆ØU V√Ä THO√ÅT ==========
    function saveAndExit(gameType) {
      let score = 0;
      let level = 1;
      
      switch(gameType) {
        case 'game1':
          score = game1State.totalScore;
          level = game1State.level;
          break;
        case 'game2':
          score = game2State.score;
          level = game2State.level;
          break;
        case 'game3':
          score = game3State.score;
          level = game3State.level;
          break;
        case 'game4':
          score = game4State.totalScore;
          level = game4State.level;
          break;
      }
      
      // L∆∞u ƒëi·ªÉm
      updateUserScore(gameType, score, level, score);
      
      // Ph√°t √¢m thanh
      SoundEffects.buttonClick();
      
      // Hi·ªÉn th·ªã th√¥ng b√°o
      showToast(`‚úÖ ƒê√£ l∆∞u ${score} ƒëi·ªÉm!`, 'success');
      
      // D·ª´ng auto-save
      stopAutoSave();
      
      // Quay v·ªÅ menu
      setTimeout(() => backToMenu(), 1000);
    }

    // ========== GI·∫¢I PH√ÅP FIX GAME 4: T√ÅCH BI·ªÜT KH·ªûI T·∫†O V√Ä TI·∫æP T·ª§C ==========
    // H√†m n√†y ch·ªâ ƒë∆∞·ª£c g·ªçi khi b·∫Øt ƒë·∫ßu game m·ªõi t·ª´ menu
    function resetGame4ForNewGame() {
      game4State = {
        level: 1,
        harvestCount: 0,
        totalScore: 0,
        plots: [
          { stage: 0 },
          { stage: 0 },
          { stage: 0 },
          { stage: 0 }
        ],
        currentQuestion: null,
        selectedPlot: null,
        combo: 0,
        maxCombo: 0
      };
      isGame4Initialized = true;
      startAutoSave('game4', () => game4State);
    }

    // H√†m c·∫≠p nh·∫≠t UI cho Game 4 (kh√¥ng reset state)
    function updateGame4UI() {
      document.getElementById('game4-level').textContent = game4State.level;
      document.getElementById('game4-harvest').textContent = game4State.harvestCount;
      document.getElementById('game4-score').textContent = game4State.totalScore;
    }

    // H√†m c·∫≠p nh·∫≠t t·∫•t c·∫£ √¥ ƒë·∫•t
    function updateAllPlotsDisplay() {
      for (let i = 0; i < game4State.plots.length; i++) {
        updatePlotDisplay(i);
      }
    }

    // Render ch√≠nh - S·ª¨A QUAN TR·ªåNG: X·ª≠ l√Ω ri√™ng cho Game 4
    function render() {
      const app = document.getElementById('app');
      
      if (currentScreen === 'login') {
        app.innerHTML = renderLogin();
        showSoundControls();
      } else if (currentScreen === 'menu') {
        app.innerHTML = renderMenu();
        showSoundControls();
        stopBackgroundMusic();
        // Khi v·ªÅ menu, ƒë√°nh d·∫•u game 4 ch∆∞a kh·ªüi t·∫°o (ƒë·ªÉ l·∫ßn sau v√†o s·∫Ω l√† game m·ªõi)
        isGame4Initialized = false;
      } else if (currentScreen === 'leaderboard') {
        app.innerHTML = renderLeaderboard();
        showSoundControls();
        stopBackgroundMusic();
      } else if (currentScreen === 'certificates') {
        app.innerHTML = renderCertificatesList();
        showSoundControls();
        stopBackgroundMusic();
      } else if (currentScreen === 'badges') {
        app.innerHTML = renderBadges();
        showSoundControls();
        stopBackgroundMusic();
      } else if (currentScreen === 'game1') {
        app.innerHTML = renderGame1();
        initGame1();
        playBackgroundMusic('game1');
        showSoundControls();
      } else if (currentScreen === 'game2') {
        app.innerHTML = renderGame2();
        initGame2();
        playBackgroundMusic('game2');
        showSoundControls();
      } else if (currentScreen === 'game3') {
        app.innerHTML = renderGame3();
        initGame3();
        playBackgroundMusic('game3');
        showSoundControls();
      } else if (currentScreen === 'game4') {
        app.innerHTML = renderGame4();
        
        // QUAN TR·ªåNG: Ch·ªâ kh·ªüi t·∫°o game n·∫øu ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o (v√†o t·ª´ menu)
        if (!isGame4Initialized) {
          resetGame4ForNewGame();
        } else {
          // N·∫øu ƒë√£ kh·ªüi t·∫°o (ƒëang ch∆°i, l√™n level), ch·ªâ c·∫≠p nh·∫≠t UI
          updateGame4UI();
          updateAllPlotsDisplay();
        }
        
        playBackgroundMusic('game4');
        showSoundControls();
      }
    }

    function renderLogin() {
      const config = window.elementSdk?.config || defaultConfig;
      const bgColor = config.background_color || defaultConfig.background_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const appTitle = config.app_title || defaultConfig.app_title;
      const welcomeMsg = config.welcome_message || defaultConfig.welcome_message;
      
      return `
        <div class="min-h-full flex items-center justify-center p-4" style="background: ${bgColor};">
          <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
              <div class="text-6xl mb-4">üéÆ</div>
              <h1 class="text-3xl font-bold mb-2" style="color: ${textColor};">${appTitle}</h1>
              <p class="text-gray-600">${welcomeMsg}</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="mb-6">
              <label for="username" class="block text-sm font-medium mb-2" style="color: ${textColor};">Nh·∫≠p t√™n c·ªßa b·∫°n</label>
              <input 
                type="text" 
                id="username" 
                class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none focus:border-blue-500 transition"
                placeholder="T√™n ng∆∞·ªùi ch∆°i"
                style="border-color: ${primaryColor}40;"
                required
              />
              <button 
                type="submit"
                class="w-full mt-4 py-3 rounded-lg text-white font-semibold hover:opacity-90 transition"
                style="background: ${primaryColor};"
                onclick="SoundEffects.buttonClick()"
              >
                B·∫Øt ƒë·∫ßu h·ªçc
              </button>
            </form>
          </div>
        </div>
      `;
    }

    function renderMenu() {
      const config = window.elementSdk?.config || defaultConfig;
      const bgColor = config.background_color || defaultConfig.background_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const game1Name = config.game1_name || defaultConfig.game1_name;
      const game2Name = config.game2_name || defaultConfig.game2_name;
      const game3Name = config.game3_name || defaultConfig.game3_name;
      const game4Name = config.game4_name || defaultConfig.game4_name;
      
      const games = [
        { id: 'game1', name: game1Name, icon: 'üé¥', color: primaryColor, desc: 'L·∫≠t th·∫ª t√¨m c·∫∑p t·ª´ kh·ªõp' },
        { id: 'game2', name: game2Name, icon: 'üß∫', color: secondaryColor, desc: 'H·ª©ng ƒë√°p √°n ƒë√∫ng r∆°i xu·ªëng' },
        { id: 'game3', name: game3Name, icon: 'üéØ', color: '#8b5cf6', desc: 'B·∫Øn k·∫ª ƒë·ªãch b·∫±ng ƒë√°p √°n ƒë√∫ng' },
        { id: 'game4', name: game4Name, icon: 'üåæ', color: '#10b981', desc: 'Tr·ªìng c√¢y b·∫±ng ki·∫øn th·ª©c' }
      ];

      const certCount = (currentUser.certificates || []).length;
      const userStats = getUserStats(currentUser.name);
      const userRank = getCurrentUserRank();
      
      // Th√¥ng tin offline
      const offlineTimestamp = localStorage.getItem('xedang_offline_timestamp');
      const offlineStatus = !isOnline ? 'üìµ Offline' : 'üì∂ Online';
      const dataCount = gameData.game1.length + gameData.game2.length + gameData.game3.length + gameData.game4.length;

      return `
        <div class="min-h-full p-4" style="background: ${bgColor};">
          <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
              <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                <div>
                  <h2 class="text-2xl font-bold" style="color: ${textColor};">Xin ch√†o, ${currentUser.name}! üëã</h2>
                  <div class="flex flex-wrap items-center gap-3 mt-2">
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">
                      Level ${currentUser.level || 1}
                    </span>
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                      ƒêi·ªÉm: ${currentUser.totalScore || 0}
                    </span>
                    <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">
                      ${currentUser.gamesPlayed || 0} tr·∫≠n
                    </span>
                    ${userRank ? `
                      <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-medium">
                        H·∫°ng: #${userRank}
                      </span>
                    ` : ''}
                  </div>
                  ${certCount > 0 ? `<p class="text-sm text-amber-600 mt-2">üèÜ ${certCount} ch·ª©ng nh·∫≠n</p>` : ''}
                  <p class="text-xs text-gray-500 mt-2">${offlineStatus} ‚Ä¢ ${dataCount} c√¢u h·ªèi ƒë√£ l∆∞u</p>
                </div>
                <div class="flex flex-wrap gap-3">
                  ${certCount > 0 ? `
                    <button onclick="showCertificatesList()" class="px-4 py-2 rounded-lg font-medium hover:opacity-80 transition" style="background: #f59e0b; color: white;" onclick="SoundEffects.buttonClick()">
                      üìú Ch·ª©ng nh·∫≠n
                    </button>
                  ` : ''}
                  <button onclick="showLeaderboard()" class="px-4 py-2 rounded-lg font-medium hover:opacity-80 transition" style="background: ${secondaryColor}; color: white;" onclick="SoundEffects.buttonClick()">
                    üèÜ B·∫£ng x·∫øp h·∫°ng
                  </button>
                  <button onclick="logout()" class="px-4 py-2 bg-gray-200 rounded-lg font-medium hover:bg-gray-300 transition" style="color: ${textColor};" onclick="SoundEffects.buttonClick()">
                    ƒêƒÉng xu·∫•t
                  </button>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              ${games.map(game => `
                <div 
                  onclick="startGame('${game.id}'); SoundEffects.buttonClick()" 
                  class="bg-white rounded-2xl shadow-lg p-8 cursor-pointer hover:shadow-2xl transition transform hover:-translate-y-1"
                >
                  <div class="text-6xl mb-4 text-center">${game.icon}</div>
                  <h3 class="text-2xl font-bold text-center mb-2" style="color: ${textColor};">${game.name}</h3>
                  <p class="text-center text-gray-600 text-sm mb-4">${game.desc}</p>
                  <div class="h-2 rounded-full mt-4" style="background: ${game.color}20;">
                    <div class="h-full rounded-full transition-all" style="width: ${Math.min(100, currentUser.level * 10)}%; background: ${game.color};"></div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderLeaderboard() {
      const config = window.elementSdk?.config || defaultConfig;
      const bgColor = config.background_color || defaultConfig.background_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const leaderboard = getLeaderboard();
      const currentUserRank = getCurrentUserRank();
      const currentUserStats = currentUser ? getUserStats(currentUser.name) : null;

      return `
        <div class="min-h-full p-4" style="background: ${bgColor};">
          <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
              <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4">
                <div>
                  <h2 class="text-3xl font-bold" style="color: ${textColor};">üèÜ B·∫£ng x·∫øp h·∫°ng</h2>
                  <p class="text-gray-600 mt-2">Top 10 ng∆∞·ªùi ch∆°i c√≥ ƒëi·ªÉm cao nh·∫•t</p>
                </div>
                <div class="flex gap-3">
                  <button onclick="backToMenu()" class="px-4 py-2 bg-gray-200 rounded-lg font-medium hover:bg-gray-300 transition" onclick="SoundEffects.buttonClick()">
                    ‚Üê Quay l·∫°i
                  </button>
                </div>
              </div>

              <!-- Hi·ªÉn th·ªã rank c·ªßa ng∆∞·ªùi ch∆°i hi·ªán t·∫°i -->
              ${currentUser && currentUserRank ? `
                <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="flex items-center gap-3">
                        <div class="rank-badge bg-blue-500 text-white">
                          #${currentUserRank}
                        </div>
                        <div>
                          <span class="font-bold text-blue-700 text-lg">${currentUser.name}</span>
                          <div class="text-sm text-gray-600">
                            Level ${currentUser.level || 1} ‚Ä¢ ${currentUser.gamesPlayed || 0} tr·∫≠n
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="text-right">
                      <div class="text-2xl font-bold" style="color: ${primaryColor};">${currentUser.totalScore || 0}</div>
                      <div class="text-xs text-gray-500">T·ªïng ƒëi·ªÉm</div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                      <span>Ti·∫øn ƒë·ªô level</span>
                      <span>${currentUser.totalScore || 0}/5000</span>
                    </div>
                    <div class="score-progress">
                      <div class="score-progress-fill bg-blue-500" style="width: ${Math.min(100, ((currentUser.totalScore || 0) % 500) / 5)}%"></div>
                    </div>
                  </div>
                </div>
              ` : ''}

              <!-- B·∫£ng x·∫øp h·∫°ng ch√≠nh -->
              <div class="space-y-3">
                ${leaderboard.map((user, index) => {
                  const isCurrentUser = currentUser && user.name === currentUser.name;
                  const rankColors = [
                    { bg: 'bg-gradient-to-r from-yellow-50 to-amber-50', border: 'border-yellow-300', text: 'text-yellow-700' },
                    { bg: 'bg-gradient-to-r from-gray-50 to-slate-50', border: 'border-gray-300', text: 'text-gray-700' },
                    { bg: 'bg-gradient-to-r from-orange-50 to-amber-50', border: 'border-orange-300', text: 'text-orange-700' },
                    { bg: 'bg-gradient-to-r from-blue-50 to-indigo-50', border: 'border-blue-300', text: 'text-blue-700' }
                  ];
                  
                  const rankColor = index < 3 ? rankColors[index] : rankColors[3];
                  const rankBg = isCurrentUser ? 'bg-gradient-to-r from-blue-100 to-indigo-100 border-blue-300' : rankColors.bg;
                  const rankBorder = isCurrentUser ? 'border-blue-300 border-2' : `border ${rankColors.border}`;
                  
                  return `
                    <div class="leaderboard-entry flex items-center justify-between p-4 rounded-xl ${rankBg} ${rankBorder} ${isCurrentUser ? 'ring-2 ring-blue-300' : ''}">
                      <div class="flex items-center gap-4">
                        <div class="rank-badge ${index === 0 ? 'bg-yellow-500 text-white' : index === 1 ? 'bg-gray-400 text-white' : index === 2 ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-700'}">
                          ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`}
                        </div>
                        <div>
                          <div class="font-bold text-lg ${isCurrentUser ? 'text-blue-700' : rankColors.text}">
                            ${user.name}
                            ${isCurrentUser ? ' (B·∫°n)' : ''}
                          </div>
                          <div class="text-sm text-gray-600">
                            Level ${user.level} ‚Ä¢ ${user.gamesPlayed} tr·∫≠n
                            ${user.bestScore > 0 ? `‚Ä¢ Cao nh·∫•t: ${user.bestScore}` : ''}
                          </div>
                        </div>
                      </div>
                      <div class="text-right">
                        <div class="text-2xl font-bold" style="color: ${primaryColor};">${user.totalScore}</div>
                        <div class="text-xs text-gray-500">T·ªïng ƒëi·ªÉm</div>
                        <div class="text-xs text-gray-400 mt-1">
                          ${user.lastPlayed ? 'Ch∆°i: ' + new Date(user.lastPlayed).toLocaleDateString('vi-VN') : ''}
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
                
                ${leaderboard.length === 0 ? `
                  <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">üèÜ</div>
                    <p class="text-lg">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o</p>
                    <p class="text-sm text-gray-400 mt-2">H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n l·∫≠p k·ª∑ l·ª•c!</p>
                    <button onclick="backToMenu()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                      B·∫Øt ƒë·∫ßu ch∆°i ngay
                    </button>
                  </div>
                ` : ''}
              </div>
              
              <!-- Th·ªëng k√™ b·ªï sung -->
              ${leaderboard.length > 0 ? `
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div class="bg-blue-50 rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600">${leaderboard[0]?.totalScore || 0}</div>
                    <div class="text-sm text-gray-600">ƒêi·ªÉm cao nh·∫•t</div>
                    <div class="text-xs text-gray-500 mt-1">${leaderboard[0]?.name || 'Ch∆∞a c√≥'}</div>
                  </div>
                  <div class="bg-green-50 rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-green-600">${leaderboard.reduce((sum, user) => sum + user.gamesPlayed, 0)}</div>
                    <div class="text-sm text-gray-600">T·ªïng s·ªë tr·∫≠n</div>
                    <div class="text-xs text-gray-500 mt-1">T·∫•t c·∫£ ng∆∞·ªùi ch∆°i</div>
                  </div>
                  <div class="bg-purple-50 rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-purple-600">${leaderboard.length}</div>
                    <div class="text-sm text-gray-600">Ng∆∞·ªùi ch∆°i</div>
                    <div class="text-xs text-gray-500 mt-1">ƒêang ho·∫°t ƒë·ªông</div>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function renderCertificatesList() {
      const config = window.elementSdk?.config || defaultConfig;
      const bgColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const certificates = currentUser.certificates || [];

      return `
        <div class="min-h-full p-4" style="background: ${bgColor};">
          <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-3xl font-bold" style="color: ${textColor};">üìú Ch·ª©ng Nh·∫≠n C·ªßa B·∫°n</h2>
                <button onclick="backToMenu()" class="px-4 py-2 bg-gray-200 rounded-lg font-medium hover:bg-gray-300 transition" onclick="SoundEffects.buttonClick()">
                  ‚Üê Quay l·∫°i
                </button>
              </div>

              ${certificates.length === 0 ? `
                <div class="text-center py-16">
                  <div class="text-7xl mb-4">üìú</div>
                  <p class="text-gray-500 text-lg">Ch∆∞a c√≥ ch·ª©ng nh·∫≠n n√†o</p>
                  <p class="text-gray-400 text-sm mt-2">Ho√†n th√†nh c√°c game ƒë·ªÉ nh·∫≠n ch·ª©ng nh·∫≠n!</p>
                </div>
              ` : `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  ${certificates.map((cert, index) => `
                    <div class="bg-gradient-to-br from-amber-50 to-yellow-50 rounded-xl shadow-lg p-6 border-2 border-amber-200 hover:shadow-xl transition">
                      <div class="flex items-start justify-between mb-4">
                        <div>
                          <h3 class="text-xl font-bold" style="color: ${textColor};">${cert.gameName}</h3>
                          <p class="text-sm text-gray-600">Ng√†y: ${cert.date}</p>
                        </div>
                        <div class="text-3xl">üèÜ</div>
                      </div>
                      <div class="bg-white rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-2 gap-3 text-center">
                          <div>
                            <div class="text-xs text-gray-600">ƒêi·ªÉm</div>
                            <div class="text-2xl font-bold text-amber-600">${cert.score}</div>
                          </div>
                          <div>
                            <div class="text-xs text-gray-600">Level</div>
                            <div class="text-2xl font-bold text-amber-600">${cert.level}</div>
                          </div>
                        </div>
                      </div>
                      <button 
                        onclick="viewCertificate(${index}); SoundEffects.buttonClick()" 
                        class="w-full py-2 bg-amber-500 text-white rounded-lg font-semibold hover:bg-amber-600 transition"
                      >
                        üëÅÔ∏è Xem & T·∫£i xu·ªëng
                      </button>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderBadges() {
      const config = window.elementSdk?.config || defaultConfig;
      const bgColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const badges = currentUser.badges || [];

      // T·∫•t c·∫£ huy hi·ªáu c√≥ th·ªÉ ƒë·∫°t ƒë∆∞·ª£c
      const allBadges = [
        // Streak badges
        { id: 'streak_3', name: 'üî• Streak 3 ng√†y', desc: 'Ch∆°i li√™n t·ª•c 3 ng√†y', category: 'Streak' },
        { id: 'streak_7', name: 'üî•üî• Streak 7 ng√†y', desc: 'Ch∆°i li√™n t·ª•c 7 ng√†y', category: 'Streak' },
        { id: 'streak_14', name: 'üî•üî•üî• Streak 14 ng√†y', desc: 'Ch∆°i li√™n t·ª•c 14 ng√†y', category: 'Streak' },
        { id: 'streak_30', name: 'üî•üî•üî•üî• Streak 30 ng√†y', desc: 'Ch∆°i li√™n t·ª•c 30 ng√†y', category: 'Streak' },
        
        // Combo badges
        { id: 'combo_5', name: '‚ö° Combo x5', desc: 'Tr·∫£ l·ªùi ƒë√∫ng li√™n ti·∫øp 5 l·∫ßn', category: 'Combo' },
        { id: 'combo_10', name: '‚ö°‚ö° Combo x10', desc: 'Tr·∫£ l·ªùi ƒë√∫ng li√™n ti·∫øp 10 l·∫ßn', category: 'Combo' },
        { id: 'combo_20', name: '‚ö°‚ö°‚ö° Combo x20', desc: 'Tr·∫£ l·ªùi ƒë√∫ng li√™n ti·∫øp 20 l·∫ßn', category: 'Combo' },
        
        // Score badges
        { id: 'score_100', name: '‚≠ê ƒêi·ªÉm 100+', desc: 'ƒê·∫°t t·ªïng ƒëi·ªÉm 100', category: 'ƒêi·ªÉm' },
        { id: 'score_500', name: '‚≠ê‚≠ê ƒêi·ªÉm 500+', desc: 'ƒê·∫°t t·ªïng ƒëi·ªÉm 500', category: 'ƒêi·ªÉm' },
        { id: 'score_1000', name: '‚≠ê‚≠ê‚≠ê ƒêi·ªÉm 1000+', desc: 'ƒê·∫°t t·ªïng ƒëi·ªÉm 1000', category: 'ƒêi·ªÉm' },
        { id: 'score_2000', name: '‚≠ê‚≠ê‚≠ê‚≠ê ƒêi·ªÉm 2000+', desc: 'ƒê·∫°t t·ªïng ƒëi·ªÉm 2000', category: 'ƒêi·ªÉm' },
        
        // Game badges
        { id: 'games_5', name: 'üéÆ Ch∆°i 5 tr·∫≠n', desc: 'Ho√†n th√†nh 5 tr·∫≠n game', category: 'Game' },
        { id: 'games_10', name: 'üéÆüéÆ Ch∆°i 10 tr·∫≠n', desc: 'Ho√†n th√†nh 10 tr·∫≠n game', category: 'Game' },
        { id: 'games_25', name: 'üéÆüéÆüéÆ Ch∆°i 25 tr·∫≠n', desc: 'Ho√†n th√†nh 25 tr·∫≠n game', category: 'Game' },
        { id: 'games_50', name: 'üéÆüéÆüéÆüéÆ Ch∆°i 50 tr·∫≠n', desc: 'Ho√†n th√†nh 50 tr·∫≠n game', category: 'Game' }
      ];

      const earnedBadgeIds = badges.map(b => b.id);
      
      return `
        <div class="min-h-full p-4" style="background: ${bgColor};">
          <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h2 class="text-3xl font-bold" style="color: ${textColor};">üéñÔ∏è B·ªô S∆∞u T·∫≠p Huy Hi·ªáu</h2>
                  <p class="text-gray-600 mt-2">ƒê√£ m·ªü kh√≥a: ${badges.length}/${allBadges.length} huy hi·ªáu</p>
                </div>
                <button onclick="backToMenu()" class="px-4 py-2 bg-gray-200 rounded-lg font-medium hover:bg-gray-300 transition" onclick="SoundEffects.buttonClick()">
                  ‚Üê Quay l·∫°i
                </button>
              </div>

              ${['Streak', 'Combo', 'ƒêi·ªÉm', 'Game'].map(category => {
                const categoryBadges = allBadges.filter(b => b.category === category);
                return `
                  <div class="mb-8">
                    <h3 class="text-xl font-bold mb-4" style="color: ${textColor};">üìÇ ${category}</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                      ${categoryBadges.map(badge => {
                        const earned = earnedBadgeIds.includes(badge.id);
                        const earnedBadge = badges.find(b => b.id === badge.id);
                        
                        return `
                          <div class="relative bg-gradient-to-br ${earned ? 'from-yellow-50 to-amber-100 border-amber-300' : 'from-gray-50 to-gray-100 border-gray-300'} rounded-xl p-6 border-2 text-center ${earned ? '' : 'opacity-50'}">
                            <div class="text-5xl mb-3 ${earned ? '' : 'grayscale'}">${badge.name.split(' ')[0]}</div>
                            <div class="text-sm font-bold ${earned ? 'text-amber-800' : 'text-gray-600'} mb-2">${badge.name}</div>
                            <div class="text-xs ${earned ? 'text-amber-600' : 'text-gray-500'} mb-2">${badge.desc}</div>
                            ${earned ? `
                              <div class="absolute top-2 right-2 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-xs">‚úì</div>
                              <div class="text-xs text-gray-500 mt-2">üìÖ ${earnedBadge.earnedDate}</div>
                            ` : `
                              <div class="text-xs text-gray-400 mt-2">üîí Ch∆∞a m·ªü kh√≥a</div>
                            `}
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // ========== GAME 1: L·∫¨T √î GHI NH·ªö ==========
    function renderGame1() {
      const config = window.elementSdk?.config || defaultConfig;
      const bgColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const game1Name = config.game1_name || defaultConfig.game1_name;
      
      return `
        <div class="min-h-full p-4" style="background: ${bgColor};">
          <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h2 class="text-2xl font-bold" style="color: ${textColor};">üé¥ ${game1Name}</h2>
                  <p class="text-sm text-gray-600 mt-1">T√¨m c·∫∑p th·∫ª kh·ªõp nhau</p>
                </div>
                <div class="flex gap-2">
                  <button onclick="saveAndExit('game1')" class="px-4 py-2 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition" onclick="SoundEffects.buttonClick()">
                    üíæ L∆∞u & Tho√°t
                  </button>
                  <button onclick="backToMenu()" class="px-4 py-2 bg-gray-200 rounded-lg font-medium hover:bg-gray-300 transition" onclick="SoundEffects.buttonClick()">
                    ‚Üê Menu
                  </button>
                </div>
              </div>
              <div class="grid grid-cols-4 gap-4">
                <div class="bg-blue-50 rounded-lg p-3 text-center">
                  <div class="text-xs text-gray-600">Level</div>
                  <div class="text-xl font-bold" style="color: ${primaryColor};"><span id="game1-level">1</span></div>
                </div>
                <div class="bg-purple-50 rounded-lg p-3 text-center">
                  <div class="text-xs text-gray-600">S·ªë b∆∞·ªõc</div>
                  <div class="text-xl font-bold" style="color: ${textColor};"><span id="moves">0</span></div>
                </div>
                <div class="bg-green-50 rounded-lg p-3 text-center">
                  <div class="text-xs text-gray-600">ƒê√£ gh√©p</div>
                  <div class="text-xl font-bold" style="color: ${textColor};"><span id="matched">0</span>/<span id="total-pairs">0</span></div>
                </div>
                <div class="bg-orange-50 rounded-lg p-3 text-center">
                  <div class="text-xs text-gray-600">ƒêi·ªÉm</div>
                  <div class="text-xl font-bold" style="color: ${primaryColor};"><span id="game1-score">0</span></div>
                </div>
              </div>
            </div>

            <div id="game1-board" class="grid gap-4"></div>
          </div>
        </div>
      `;
    }

    function initGame1() {
      game1State.level = 1;
      game1State.moves = 0;
      game1State.matchedPairs = 0;
      game1State.totalScore = 0;
      game1State.flippedCards = [];
      
      // B·∫Øt ƒë·∫ßu auto-save
      startAutoSave('game1', () => game1State);
      
      startGame1Level();
    }

    function startGame1Level() {
      const pairCount = Math.min(2 + game1State.level - 1, 6);
      game1State.totalPairs = pairCount;
      
      const selectedData = gameData.game1.slice().sort(() => Math.random() - 0.5).slice(0, pairCount);
      
      const cards = [];
      selectedData.forEach((item, index) => {
        cards.push({ id: `q${index}`, content: item[0], type: 'question', pairId: index });
        cards.push({ id: `a${index}`, content: item[1], type: 'answer', pairId: index });
      });

      cards.sort(() => Math.random() - 0.5);
      game1State.cards = cards;
      game1State.flippedCards = [];
      game1State.matchedPairs = 0;

      document.getElementById('game1-level').textContent = game1State.level;
      document.getElementById('moves').textContent = game1State.moves;
      document.getElementById('matched').textContent = game1State.matchedPairs;
      document.getElementById('total-pairs').textContent = pairCount;
      document.getElementById('game1-score').textContent = game1State.totalScore;

      const totalCards = pairCount * 2;
      const cols = totalCards <= 4 ? 2 : totalCards <= 6 ? 3 : totalCards <= 8 ? 4 : totalCards <= 10 ? 5 : 6;

      const board = document.getElementById('game1-board');
      board.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      board.innerHTML = cards.map((card, index) => `
        <div class="card" data-index="${index}" onclick="flipCard(${index})" style="height: 120px;">
          <div class="card-inner">
            <div class="card-front">
              <span>üé¥</span>
            </div>
            <div class="card-back">
              <span>${card.content}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function flipCard(index) {
      const card = game1State.cards[index];
      const cardElement = document.querySelector(`[data-index="${index}"]`);

      if (game1State.flippedCards.length >= 2 || 
          game1State.flippedCards.includes(index) || 
          cardElement.classList.contains('matched')) {
        return;
      }

      // Ph√°t √¢m thanh l·∫≠t th·∫ª
      SoundEffects.flipCard();
      
      cardElement.classList.add('flipped');
      game1State.flippedCards.push(index);

      if (game1State.flippedCards.length === 2) {
        game1State.moves++;
        document.getElementById('moves').textContent = game1State.moves;

        const [idx1, idx2] = game1State.flippedCards;
        const card1 = game1State.cards[idx1];
        const card2 = game1State.cards[idx2];

        if (card1.pairId === card2.pairId) {
          // Ph√°t √¢m thanh kh·ªõp th√†nh c√¥ng
          setTimeout(() => SoundEffects.matchSuccess(), 100);
          
          setTimeout(() => {
            document.querySelector(`[data-index="${idx1}"]`).classList.add('matched');
            document.querySelector(`[data-index="${idx2}"]`).classList.add('matched');
            game1State.matchedPairs++;
            document.getElementById('matched').textContent = game1State.matchedPairs;
            game1State.flippedCards = [];

            if (game1State.matchedPairs === game1State.totalPairs) {
              completeGame1Level();
            }
          }, 500);
        } else {
          // Ph√°t √¢m thanh kh·ªõp th·∫•t b·∫°i
          setTimeout(() => SoundEffects.matchFail(), 300);
          
          setTimeout(() => {
            document.querySelector(`[data-index="${idx1}"]`).classList.remove('flipped');
            document.querySelector(`[data-index="${idx2}"]`).classList.remove('flipped');
            game1State.flippedCards = [];
          }, 1000);
        }
      }
    }

    function completeGame1Level() {
      const levelScore = Math.max(0, 100 - game1State.moves * 5 + game1State.level * 10);
      game1State.totalScore += levelScore;
      document.getElementById('game1-score').textContent = game1State.totalScore;

      // L∆∞u ƒëi·ªÉm sau m·ªói level
      updateUserScore('game1', game1State.totalScore, game1State.level, game1State.totalScore);

      // Ph√°t √¢m thanh ho√†n th√†nh level
      setTimeout(() => SoundEffects.levelComplete(), 200);
      
      setTimeout(() => {
        showLevelCompleteModal(
          game1State.level,
          levelScore,
          game1State.moves,
          () => {
            if (game1State.level >= 5) {
              // Hi·ªÉn th·ªã certificate khi ho√†n th√†nh level 5
              showToast(`üéâ Ho√†n th√†nh t·∫•t c·∫£ 5 level! T·ªïng ƒëi·ªÉm: ${game1State.totalScore}`, 'success');
              setTimeout(() => {
                showCertificate('L·∫≠t √î Ghi Nh·ªõ', game1State.totalScore, 5);
              }, 1000);
            } else {
              game1State.level++;
              game1State.moves = 0;
              game1State.matchedPairs = 0;
              game1State.flippedCards = [];
              
              setTimeout(() => startGame1Level(), 300);
            }
          }
        );
      }, 500);
    }

    // ========== GAME 2: M∆ØA T·ª™ V·ª∞NG ==========
    function renderGame2() {
      const config = window.elementSdk?.config || defaultConfig;
      const bgColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const game2Name = config.game2_name || defaultConfig.game2_name;
      
      return `
        <div class="min-h-full p-4" style="background: ${bgColor};">
          <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-4">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h2 class="text-2xl font-bold" style="color: ${textColor};">üß∫ ${game2Name}</h2>
                  <p class="text-sm text-gray-600 mt-1">Di chuy·ªÉn gi·ªè h·ª©ng ƒë√°p √°n ƒë√∫ng</p>
                </div>
                <div class="flex gap-2">
                  <button onclick="saveAndExit('game2')" class="px-4 py-2 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition" onclick="SoundEffects.buttonClick()">
                    üíæ L∆∞u & Tho√°t
                  </button>
                  <button onclick="endGame2()" class="px-4 py-2 bg-gray-200 rounded-lg font-medium hover:bg-gray-300 transition" onclick="SoundEffects.buttonClick()">
                    ‚Üê K·∫øt th√∫c
                  </button>
                </div>
              </div>
              <div class="grid grid-cols-5 gap-3">
                <div class="bg-blue-50 rounded-lg p-2 text-center">
                  <div class="text-xs text-gray-600">Level</div>
                  <div class="text-lg font-bold" style="color: ${primaryColor};"><span id="game2-level">1</span></div>
                </div>
                <div class="bg-green-50 rounded-lg p-2 text-center">
                  <div class="text-xs text-gray-600">ƒêi·ªÉm</div>
                  <div class="text-lg font-bold" style="color: ${textColor};"><span id="game2-score">0</span></div>
                </div>
                <div class="bg-purple-50 rounded-lg p-2 text-center">
                  <div class="text-xs text-gray-600">ƒê√∫ng</div>
                  <div class="text-lg font-bold" style="color: ${textColor};"><span id="game2-correct">0</span>/5</div>
                </div>
                <div class="bg-red-50 rounded-lg p-2 text-center">
                  <div class="text-xs text-gray-600">M·∫°ng</div>
                  <div class="text-lg font-bold text-red-500"><span id="game2-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
                </div>
                <div class="col-span-1 bg-yellow-50 rounded-lg p-2 flex items-center justify-center">
                  <div class="text-2xl">üß∫</div>
                </div>
              </div>
              <div class="mt-3 bg-indigo-50 rounded-lg p-3 text-center">
                <div class="text-xs text-gray-600 mb-1">C√¢u h·ªèi</div>
                <div class="text-lg font-bold" style="color: ${textColor};" id="game2-question"></div>
              </div>
            </div>

            <div id="game2-canvas" class="bg-gradient-to-b from-sky-200 to-sky-50 rounded-2xl shadow-lg relative" style="height: 500px; overflow: hidden;">
              <div class="absolute bottom-0 w-full h-1 bg-green-600"></div>
            </div>

            <div class="mt-3 text-center text-sm text-gray-600">
              üí° Di chuy·ªÉn chu·ªôt ho·∫∑c ph√≠m ‚Üê ‚Üí ƒë·ªÉ ƒëi·ªÅu khi·ªÉn gi·ªè
            </div>
          </div>
        </div>
      `;
    }

    function initGame2() {
      game2State = {
        score: 0,
        level: 1,
        questionsAnswered: 0,
        currentQuestion: null,
        fallingWords: [],
        basketX: 0,
        gameLoop: null,
        questionIndex: 0,
        lives: 3,
        combo: 0,
        maxCombo: 0
      };

      // B·∫Øt ƒë·∫ßu auto-save
      startAutoSave('game2', () => game2State);

      const canvas = document.getElementById('game2-canvas');
      const basketWidth = 80;
      game2State.basketX = (canvas.offsetWidth - basketWidth) / 2;

      canvas.innerHTML = `
        <div class="basket-character" style="left: ${game2State.basketX}px;">
          <div class="basket-body">üß∫</div>
          <div class="basket-base"></div>
        </div>
      `;

      document.addEventListener('mousemove', handleGame2Mouse);
      document.addEventListener('touchmove', handleGame2Touch);
      document.addEventListener('keydown', handleGame2Keys);

      document.getElementById('game2-level').textContent = game2State.level;
      document.getElementById('game2-score').textContent = game2State.score;
      document.getElementById('game2-correct').textContent = game2State.questionsAnswered;
      updateGame2Lives();

      nextQuestion2();
      game2State.gameLoop = setInterval(updateGame2, 50);
    }

    function handleGame2Mouse(e) {
      if (currentScreen !== 'game2') return;
      const canvas = document.getElementById('game2-canvas');
      if (!canvas) return;
      
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      game2State.basketX = Math.max(0, Math.min(x - 40, canvas.offsetWidth - 80));
      const basket = canvas.querySelector('.basket-character');
      if (basket) basket.style.left = game2State.basketX + 'px';
      
      // Ph√°t √¢m thanh di chuy·ªÉn nh·∫π
      if (Math.random() > 0.8) {
        SoundEffects.basketMove();
      }
    }

    function handleGame2Touch(e) {
      if (currentScreen !== 'game2') return;
      e.preventDefault();
      const canvas = document.getElementById('game2-canvas');
      if (!canvas) return;
      
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      game2State.basketX = Math.max(0, Math.min(x - 40, canvas.offsetWidth - 80));
      const basket = canvas.querySelector('.basket-character');
      if (basket) basket.style.left = game2State.basketX + 'px';
    }

    function handleGame2Keys(e) {
      if (currentScreen !== 'game2') return;
      const canvas = document.getElementById('game2-canvas');
      if (!canvas) return;

      if (e.key === 'ArrowLeft') {
        game2State.basketX = Math.max(0, game2State.basketX - 25);
        SoundEffects.basketMove();
      } else if (e.key === 'ArrowRight') {
        game2State.basketX = Math.min(canvas.offsetWidth - 80, game2State.basketX + 25);
        SoundEffects.basketMove();
      }
      const basket = canvas.querySelector('.basket-character');
      if (basket) basket.style.left = game2State.basketX + 'px';
    }

    function nextQuestion2() {
      if (game2State.questionIndex >= gameData.game2.length) {
        game2State.questionIndex = 0;
      }

      const questionData = gameData.game2[game2State.questionIndex];
      game2State.currentQuestion = {
        question: questionData[0],
        correctAnswer: questionData[1],
        wrongAnswers: questionData.slice(2).filter(a => a && a.trim())
      };

      document.getElementById('game2-question').textContent = game2State.currentQuestion.question;

      const canvas = document.getElementById('game2-canvas');
      const allAnswers = [game2State.currentQuestion.correctAnswer, ...game2State.currentQuestion.wrongAnswers]
        .sort(() => Math.random() - 0.5)
        .slice(0, 4);

      const speed = 1.5 + game2State.level * 0.3;

      game2State.fallingWords.forEach(w => {
        if (w.element && w.element.parentNode) {
          w.element.remove();
        }
      });
      game2State.fallingWords = [];

      allAnswers.forEach((answer, i) => {
        setTimeout(() => {
          const word = document.createElement('div');
          word.className = 'falling-word';
          word.textContent = answer;
          word.dataset.correct = (answer === game2State.currentQuestion.correctAnswer) ? 'true' : 'false';
          word.style.left = (Math.random() * (canvas.offsetWidth - 120)) + 'px';
          word.style.top = '-50px';
          word.style.background = word.dataset.correct === 'true' ? 
            'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 
            'linear-gradient(135deg, #ef4444 0%, #b91c1c 100%)';
          
          canvas.appendChild(word);
          game2State.fallingWords.push({
            element: word,
            y: -50,
            x: parseFloat(word.style.left),
            correct: word.dataset.correct === 'true',
            speed: speed,
            caught: false,
            answer: answer
          });
        }, i * 800);
      });

      game2State.questionIndex++;
    }

    function updateGame2() {
      const canvas = document.getElementById('game2-canvas');
      if (!canvas) return;

      let correctWordMissed = false;

      game2State.fallingWords = game2State.fallingWords.filter(word => {
        if (word.exploded) {
          return false;
        }

        word.y += word.speed;
        word.element.style.top = word.y + 'px';

        if (word.y > canvas.offsetHeight) {
          if (word.correct && !word.caught) {
            game2State.lives--;
            updateGame2Lives();
            showToast('B·ªè l·ª° ƒë√°p √°n ƒë√∫ng! -1 m·∫°ng', 'error');
            correctWordMissed = true;
            
            // Ph√°t √¢m thanh b·ªè l·ª°
            SoundEffects.wordMissed();
            
            if (game2State.lives <= 0) {
              if (game2State.gameLoop) {
                clearInterval(game2State.gameLoop);
                game2State.gameLoop = null;
              }
              document.removeEventListener('mousemove', handleGame2Mouse);
              document.removeEventListener('touchmove', handleGame2Touch);
              document.removeEventListener('keydown', handleGame2Keys);
              
              // Ph√°t √¢m thanh game over
              SoundEffects.gameOver();
              
              // L∆∞u ƒëi·ªÉm
              updateUserScore('game2', game2State.score, game2State.level, game2State.score);
              
              showGameOverModal(
                game2State.score,
                game2State.level,
                () => {
                  currentScreen = 'game2';
                  render();
                },
                () => backToMenu()
              );
              return;
            }
          }
          word.element.remove();
          return false;
        }

        if (!word.caught && word.y > canvas.offsetHeight - 120 && word.y < canvas.offsetHeight - 10) {
          const wordCenterX = word.x + 40;
          const basketCenterX = game2State.basketX + 40;
          
          if (Math.abs(wordCenterX - basketCenterX) < 60) {
            word.caught = true;
            if (word.correct) {
              // Ph√°t √¢m thanh h·ª©ng ƒë√∫ng
              SoundEffects.wordCaught();
              
              game2State.score += 20;
              game2State.questionsAnswered++;
              document.getElementById('game2-score').textContent = game2State.score;
              document.getElementById('game2-correct').textContent = game2State.questionsAnswered;
              
              const basket = canvas.querySelector('.basket-character');
              const basketX = parseFloat(basket.style.left);
              
              basket.style.animation = 'basketSquash 0.4s ease-out';
              setTimeout(() => basket.style.animation = '', 400);
              
              for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                  const ring = document.createElement('div');
                  ring.style.position = 'absolute';
                  ring.style.left = (basketX + 40) + 'px';
                  ring.style.bottom = '70px';
                  ring.style.width = '80px';
                  ring.style.height = '80px';
                  ring.style.border = '3px solid #10b981';
                  ring.style.borderRadius = '50%';
                  ring.style.pointerEvents = 'none';
                  ring.style.animation = 'impactRing 0.6s ease-out';
                  canvas.appendChild(ring);
                  setTimeout(() => ring.remove(), 600);
                }, i * 100);
              }
              
              word.element.style.animation = 'wordAbsorb 0.6s ease-out forwards';
              word.element.style.background = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
              word.element.style.boxShadow = '0 0 30px rgba(251, 191, 36, 0.9)';
              
              for (let i = 0; i < 12; i++) {
                const angle = (i / 12) * Math.PI * 2;
                const star = document.createElement('div');
                star.style.position = 'absolute';
                star.style.left = (basketX + 40) + 'px';
                star.style.bottom = '70px';
                star.style.fontSize = '24px';
                star.textContent = ['‚ú®', '‚≠ê', 'üåü', 'üí´', 'üéâ'][Math.floor(Math.random() * 5)];
                star.style.pointerEvents = 'none';
                star.style.transition = 'all 0.7s ease-out';
                star.style.opacity = '1';
                canvas.appendChild(star);
                
                const distance = 60 + Math.random() * 40;
                setTimeout(() => {
                  star.style.left = (basketX + 40 + Math.cos(angle) * distance) + 'px';
                  star.style.bottom = (70 + Math.sin(angle) * distance) + 'px';
                  star.style.opacity = '0';
                  star.style.transform = 'rotate(360deg) scale(1.8)';
                }, 10);
                
                setTimeout(() => star.remove(), 700);
              }
              
              const scoreText = document.createElement('div');
              scoreText.textContent = '+20';
              scoreText.style.position = 'absolute';
              scoreText.style.left = (basketX + 20) + 'px';
              scoreText.style.bottom = '90px';
              scoreText.style.fontSize = '42px';
              scoreText.style.fontWeight = '900';
              scoreText.style.color = '#fbbf24';
              scoreText.style.textShadow = '0 0 15px rgba(251, 191, 36, 1), 0 4px 8px rgba(0,0,0,0.4)';
              scoreText.style.pointerEvents = 'none';
              scoreText.style.transition = 'all 0.8s ease-out';
              canvas.appendChild(scoreText);
              
              setTimeout(() => {
                scoreText.style.bottom = '220px';
                scoreText.style.opacity = '0';
                scoreText.style.transform = 'scale(2.5)';
              }, 10);
              setTimeout(() => scoreText.remove(), 800);
              
              setTimeout(() => word.element.remove(), 600);
              
              setTimeout(() => {
                explodeWrongAnswers();
                
                if (game2State.questionsAnswered >= 5) {
                  setTimeout(() => completeGame2Level(), 600);
                } else {
                  setTimeout(() => nextQuestion2(), 1000);
                }
              }, 700);
              
              return false;
            } else {
              // Ph√°t √¢m thanh h·ª©ng sai
              SoundEffects.wrongAnswerGeneral();
              
              game2State.score = Math.max(0, game2State.score - 5);
              document.getElementById('game2-score').textContent = game2State.score;
              word.element.classList.add('shake');
              showToast('H·ª©ng sai r·ªìi! -5 ƒëi·ªÉm', 'error');
            }
          }
        }

        return true;
      });

      if (correctWordMissed && game2State.lives > 0 && game2State.questionsAnswered < 5) {
        setTimeout(() => nextQuestion2(), 1000);
      }
    }

    function explodeWrongAnswers() {
      const canvas = document.getElementById('game2-canvas');
      if (!canvas) return;

      game2State.fallingWords.forEach(word => {
        if (!word.correct && !word.caught && !word.exploded) {
          word.exploded = true;
          
          const wordRect = word.element.getBoundingClientRect();
          const canvasRect = canvas.getBoundingClientRect();
          const centerX = wordRect.left - canvasRect.left + wordRect.width / 2;
          const centerY = wordRect.top - canvasRect.top + wordRect.height / 2;
          
          const explosionEmojis = ['üí•', '‚ú®', '‚≠ê', 'üî•', 'üí´'];
          
          explosionEmojis.forEach((emoji, i) => {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.textContent = emoji;
            explosion.style.left = centerX + 'px';
            explosion.style.top = centerY + 'px';
            explosion.style.fontSize = '48px';
            explosion.style.position = 'absolute';
            explosion.style.pointerEvents = 'none';
            explosion.style.animationDelay = (i * 0.05) + 's';
            canvas.appendChild(explosion);
            
            setTimeout(() => explosion.remove(), 800);
          });
          
          for (let i = 0; i < 8; i++) {
            const particle = document.createElement('div');
            particle.style.position = 'absolute';
            particle.style.left = centerX + 'px';
            particle.style.top = centerY + 'px';
            particle.style.fontSize = '20px';
            particle.textContent = ['üí´', '‚ú®', '‚≠ê'][Math.floor(Math.random() * 3)];
            particle.style.pointerEvents = 'none';
            
            const angle = (i / 8) * Math.PI * 2;
            const distance = 60 + Math.random() * 40;
            particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
            particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
            particle.style.animation = 'explodeParticle 0.8s ease-out forwards';
            
            canvas.appendChild(particle);
            setTimeout(() => particle.remove(), 800);
          }
          
          word.element.style.transition = 'all 0.3s ease-out';
          word.element.style.transform = 'scale(0) rotate(180deg)';
          word.element.style.opacity = '0';
          
          setTimeout(() => word.element.remove(), 300);
        }
      });

      game2State.fallingWords = game2State.fallingWords.filter(w => !w.exploded);
    }

    function updateGame2Lives() {
      const hearts = ['‚ù§Ô∏è', '‚ù§Ô∏è', '‚ù§Ô∏è'];
      for (let i = 0; i < 3 - game2State.lives; i++) {
        hearts[i] = 'üñ§';
      }
      document.getElementById('game2-lives').textContent = hearts.join('');
    }

    function completeGame2Level() {
      if (game2State.gameLoop) {
        clearInterval(game2State.gameLoop);
        game2State.gameLoop = null;
      }

      const levelBonus = game2State.level * 50;
      game2State.score += levelBonus;
      document.getElementById('game2-score').textContent = game2State.score;

      // L∆∞u ƒëi·ªÉm
      updateUserScore('game2', game2State.score, game2State.level, game2State.score);

      // Ph√°t √¢m thanh level up
      SoundEffects.levelUpGame2();
      
      showLevelCompleteModal(
        game2State.level,
        levelBonus,
        game2State.questionsAnswered,
        () => {
          if (game2State.level >= 5) {
            document.removeEventListener('mousemove', handleGame2Mouse);
            document.removeEventListener('touchmove', handleGame2Touch);
            document.removeEventListener('keydown', handleGame2Keys);
            showToast(`üéâ Ho√†n th√†nh! T·ªïng ƒëi·ªÉm: ${game2State.score}`, 'success');
            setTimeout(() => {
              showCertificate('M∆∞a T·ª´ V·ª±ng', game2State.score, 5);
            }, 1000);
          } else {
            game2State.level++;
            game2State.questionsAnswered = 0;
            game2State.lives = 3;
            
            document.getElementById('game2-level').textContent = game2State.level;
            document.getElementById('game2-correct').textContent = game2State.questionsAnswered;
            updateGame2Lives();
            
            const canvas = document.getElementById('game2-canvas');
            game2State.fallingWords.forEach(w => w.element.remove());
            game2State.fallingWords = [];
            
            nextQuestion2();
            game2State.gameLoop = setInterval(updateGame2, 50);
          }
        }
      );
    }

    function endGame2() {
      if (game2State.gameLoop) {
        clearInterval(game2State.gameLoop);
      }
      document.removeEventListener('mousemove', handleGame2Mouse);
      document.removeEventListener('touchmove', handleGame2Touch);
      document.removeEventListener('keydown', handleGame2Keys);
      
      // L∆∞u ƒëi·ªÉm
      updateUserScore('game2', game2State.score, game2State.level, game2State.score);
      
      showToast(`Game k·∫øt th√∫c! ƒêi·ªÉm: ${game2State.score}`, 'success');
      setTimeout(() => backToMenu(), 1500);
    }

    // ========== GAME 3: B·∫¢O V·ªÜ C·ª® ƒêI·ªÇM ==========
    function renderGame3() {
      const config = window.elementSdk?.config || defaultConfig;
      const bgColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const game3Name = config.game3_name || defaultConfig.game3_name;
      
      return `
        <div class="min-h-full p-4" style="background: ${bgColor};">
          <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-4">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h2 class="text-2xl font-bold" style="color: ${textColor};">üéØ ${game3Name}</h2>
                  <p class="text-sm text-gray-600 mt-1">Ch·ªçn ƒë√°p √°n ƒë√∫ng ƒë·ªÉ ti√™u di·ªát k·∫ª ƒë·ªãch</p>
                </div>
                <div class="flex gap-2">
                  <button onclick="saveAndExit('game3')" class="px-4 py-2 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition" onclick="SoundEffects.buttonClick()">
                    üíæ L∆∞u & Tho√°t
                  </button>
                  <button onclick="endGame3()" class="px-4 py-2 bg-gray-200 rounded-lg font-medium hover:bg-gray-300 transition" onclick="SoundEffects.buttonClick()">
                    ‚Üê K·∫øt th√∫c
                  </button>
                </div>
              </div>
              <div class="grid grid-cols-5 gap-3">
                <div class="bg-blue-50 rounded-lg p-2 text-center">
                  <div class="text-xs text-gray-600">Level</div>
                  <div class="text-lg font-bold" style="color: ${primaryColor};"><span id="game3-level">1</span></div>
                </div>
                <div class="bg-green-50 rounded-lg p-2 text-center">
                  <div class="text-xs text-gray-600">ƒêi·ªÉm</div>
                  <div class="text-lg font-bold" style="color: ${textColor};"><span id="game3-score">0</span></div>
                </div>
                <div class="bg-purple-50 rounded-lg p-2 text-center">
                  <div class="text-xs text-gray-600">Ti√™u di·ªát</div>
                  <div class="text-lg font-bold" style="color: ${textColor};"><span id="game3-kills">0</span>/5</div>
                </div>
                <div class="bg-red-50 rounded-lg p-2 text-center">
                  <div class="text-xs text-gray-600">M·∫°ng</div>
                  <div class="text-lg font-bold text-red-500"><span id="game3-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
                </div>
                <div class="col-span-1 bg-yellow-50 rounded-lg p-2 flex items-center justify-center">
                  <div class="text-2xl">üéØ</div>
                </div>
              </div>
              <div class="mt-3 bg-indigo-50 rounded-lg p-3 text-center">
                <div class="text-xs text-gray-600 mb-1">C√¢u h·ªèi</div>
                <div class="text-lg font-bold" style="color: ${textColor};" id="game3-question"></div>
              </div>
            </div>

            <div id="game3-canvas" class="bg-gradient-to-b from-indigo-900 via-purple-900 to-indigo-800 rounded-2xl shadow-lg relative" style="height: 400px; overflow: hidden;">
              <div class="player-turret">
                <div class="turret-head">üî´</div>
                <div class="turret-base"></div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-4" id="game3-answers"></div>
          </div>
        </div>
      `;
    }

    function initGame3() {
      game3State = {
        score: 0,
        level: 1,
        questionsAnswered: 0,
        enemies: [],
        currentQuestion: null,
        gameLoop: null,
        questionIndex: 0,
        lives: 3,
        combo: 0,
        maxCombo: 0
      };

      // B·∫Øt ƒë·∫ßu auto-save
      startAutoSave('game3', () => game3State);

      document.getElementById('game3-level').textContent = game3State.level;
      document.getElementById('game3-score').textContent = game3State.score;
      document.getElementById('game3-kills').textContent = game3State.questionsAnswered;
      updateGame3Lives();

      nextQuestion3();
      game3State.gameLoop = setInterval(updateGame3, 50);
    }

    function nextQuestion3() {
      if (game3State.questionIndex >= gameData.game3.length) {
        game3State.questionIndex = 0;
      }

      const questionData = gameData.game3[game3State.questionIndex];
      game3State.currentQuestion = {
        question: questionData[0],
        correctAnswer: questionData[1],
        allAnswers: [questionData[1], ...questionData.slice(2).filter(a => a && a.trim())]
          .sort(() => Math.random() - 0.5)
          .slice(0, 4)
      };

      document.getElementById('game3-question').textContent = game3State.currentQuestion.question;

      const answersDiv = document.getElementById('game3-answers');
      answersDiv.innerHTML = game3State.currentQuestion.allAnswers.map((answer, i) => `
        <button 
          onclick="shootAnswer('${answer.replace(/'/g, "\\'")}', this)" 
          class="py-2.5 sm:py-3 px-3 sm:px-4 text-sm sm:text-base bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition transform hover:scale-105 active:scale-95"
        >
          ${answer}
        </button>
      `).join('');

      spawnEnemy();
      game3State.questionIndex++;
    }

    function spawnEnemy() {
      const canvas = document.getElementById('game3-canvas');
      if (!canvas) return;

      const enemy = document.createElement('div');
      enemy.className = 'enemy';
      enemy.innerHTML = `
        <div class="enemy-body">üëæ</div>
        <div class="enemy-health-bar">
          <div class="enemy-health-fill" style="width: 100%;"></div>
        </div>
      `;
      enemy.style.left = '-80px';
      enemy.style.top = (Math.random() * (canvas.offsetHeight - 200) + 20) + 'px';
      
      canvas.appendChild(enemy);
      
      const speed = 0.8 + game3State.level * 0.2;
      
      game3State.enemies.push({
        element: enemy,
        x: -80,
        speed: speed,
        health: 100,
        maxHealth: 100
      });
    }

    function updateGame3() {
      const canvas = document.getElementById('game3-canvas');
      if (!canvas) return;

      game3State.enemies = game3State.enemies.filter(enemy => {
        enemy.x += enemy.speed;
        enemy.element.style.left = enemy.x + 'px';

        if (enemy.x > canvas.offsetWidth) {
          const explosion = document.createElement('div');
          explosion.className = 'explosion';
          explosion.textContent = 'üí•';
          explosion.style.left = enemy.element.style.left;
          explosion.style.top = enemy.element.style.top;
          canvas.appendChild(explosion);
          setTimeout(() => explosion.remove(), 600);

          enemy.element.remove();
          game3State.lives--;
          updateGame3Lives();
          showToast('K·∫ª ƒë·ªãch x√¢m nh·∫≠p! -1 m·∫°ng', 'error');
          
          // Ph√°t √¢m thanh k·∫ª ƒë·ªãch v∆∞·ª£t qua
          SoundEffects.enemyPass();
          
          if (game3State.lives <= 0) {
            if (game3State.gameLoop) {
              clearInterval(game3State.gameLoop);
              game3State.gameLoop = null;
            }
            
            // Ph√°t √¢m thanh game over
            SoundEffects.gameOver();
            
            // L∆∞u ƒëi·ªÉm
            updateUserScore('game3', game3State.score, game3State.level, game3State.score);
            
            showGameOverModal(
              game3State.score,
              game3State.level,
              () => {
                currentScreen = 'game3';
                render();
              },
              () => backToMenu()
            );
            return;
          } else {
            setTimeout(() => spawnEnemy(), 500);
          }
          
          return false;
        }

        return true;
      });
    }

    function updateGame3Lives() {
      const hearts = ['‚ù§Ô∏è', '‚ù§Ô∏è', '‚ù§Ô∏è'];
      for (let i = 0; i < 3 - game3State.lives; i++) {
        hearts[i] = 'üñ§';
      }
      document.getElementById('game3-lives').textContent = hearts.join('');
    }

    function shootAnswer(answer, button) {
      const canvas = document.getElementById('game3-canvas');
      if (game3State.enemies.length === 0) return;

      // Ph√°t √¢m thanh n√∫t b·∫•m
      SoundEffects.buttonClick();
      
      button.classList.add('pulse');
      setTimeout(() => button.classList.remove('pulse'), 300);

      const enemy = game3State.enemies[0];
      const turret = canvas.querySelector('.player-turret');
      const turretHead = turret.querySelector('.turret-head');
      const turretRect = turret.getBoundingClientRect();
      const canvasRect = canvas.getBoundingClientRect();
      const enemyRect = enemy.element.getBoundingClientRect();

      turretHead.classList.add('shooting');
      setTimeout(() => turretHead.classList.remove('shooting'), 300);

      const startX = turretRect.left - canvasRect.left + turretRect.width / 2;
      const startY = turretRect.top - canvasRect.top + turretRect.height / 2;
      const endX = enemyRect.left - canvasRect.left + enemyRect.width / 2;
      const endY = enemyRect.top - canvasRect.top + enemyRect.height / 2;
      
      const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
      
      const arrow = document.createElement('div');
      arrow.className = 'arrow';
      arrow.style.left = (startX - 15) + 'px';
      arrow.style.top = (startY - 15) + 'px';
      
      canvas.appendChild(arrow);

      let currentDistance = 0;
      const speed = 15;
      const flyInterval = setInterval(() => {
        currentDistance += speed;
        const progress = currentDistance / distance;
        
        if (progress >= 1) {
          clearInterval(flyInterval);
          arrow.remove();
          
          const hitEffect = document.createElement('div');
          hitEffect.style.position = 'absolute';
          hitEffect.style.left = endX + 'px';
          hitEffect.style.top = endY + 'px';
          hitEffect.style.fontSize = '32px';
          hitEffect.textContent = 'üí•';
          hitEffect.style.animation = 'explode 0.6s ease-out forwards';
          hitEffect.style.pointerEvents = 'none';
          canvas.appendChild(hitEffect);
          setTimeout(() => hitEffect.remove(), 600);

          for (let i = 0; i < 2; i++) {
            setTimeout(() => {
              const ring = document.createElement('div');
              ring.style.position = 'absolute';
              ring.style.left = endX + 'px';
              ring.style.top = endY + 'px';
              ring.style.width = '40px';
              ring.style.height = '40px';
              ring.style.border = '3px solid #ef4444';
              ring.style.borderRadius = '50%';
              ring.style.pointerEvents = 'none';
              ring.style.transform = 'translate(-50%, -50%)';
              ring.style.animation = 'impactRing 0.5s ease-out';
              canvas.appendChild(ring);
              setTimeout(() => ring.remove(), 500);
            }, i * 100);
          }

          if (answer === game3State.currentQuestion.correctAnswer) {
            // Ph√°t √¢m thanh b·∫Øn tr√∫ng
            SoundEffects.enemyHit();
            
            enemy.health -= 50;
            
            const healthBar = enemy.element.querySelector('.enemy-health-fill');
            if (healthBar) {
              healthBar.style.width = Math.max(0, (enemy.health / enemy.maxHealth) * 100) + '%';
            }

            enemy.element.classList.add('shake');
            setTimeout(() => enemy.element.classList.remove('shake'), 300);

            if (enemy.health <= 0) {
              // Ph√°t √¢m thanh ti√™u di·ªát
              SoundEffects.enemyDestroy();
              
              game3State.score += 30;
              game3State.questionsAnswered++;
              document.getElementById('game3-score').textContent = game3State.score;
              document.getElementById('game3-kills').textContent = game3State.questionsAnswered;
              
              for (let i = 0; i < 8; i++) {
                const explosion = document.createElement('div');
                explosion.textContent = ['üí•', '‚ú®', '‚≠ê', 'üî•'][Math.floor(Math.random() * 4)];
                explosion.style.position = 'absolute';
                explosion.style.left = endX + 'px';
                explosion.style.top = endY + 'px';
                explosion.style.fontSize = '40px';
                explosion.style.pointerEvents = 'none';
                
                const explosionAngle = (i / 8) * Math.PI * 2;
                const explosionDistance = 50 + Math.random() * 30;
                explosion.style.setProperty('--tx', Math.cos(explosionAngle) * explosionDistance + 'px');
                explosion.style.setProperty('--ty', Math.sin(explosionAngle) * explosionDistance + 'px');
                explosion.style.animation = 'explodeParticle 0.8s ease-out forwards';
                
                canvas.appendChild(explosion);
                setTimeout(() => explosion.remove(), 800);
              }

              enemy.element.style.transition = 'all 0.3s ease-out';
              enemy.element.style.transform = 'scale(0) rotate(180deg)';
              enemy.element.style.opacity = '0';
              
              setTimeout(() => {
                enemy.element.remove();
                game3State.enemies = game3State.enemies.filter(e => e !== enemy);
                
                if (game3State.questionsAnswered >= 5) {
                  completeGame3Level();
                } else {
                  nextQuestion3();
                }
              }, 300);
            } else {
              showToast(`Tr√∫ng m·ª•c ti√™u! C√≤n ${enemy.health}% m√°u`, 'success');
            }
          } else {
            // Ph√°t √¢m thanh b·∫Øn tr∆∞·ª£t
            SoundEffects.wrongAnswerGeneral();
            
            game3State.score = Math.max(0, game3State.score - 10);
            document.getElementById('game3-score').textContent = game3State.score;
            showToast('Tr∆∞·ª£t m·ª•c ti√™u! -10 ƒëi·ªÉm', 'error');
          }
          return;
        }

        const newX = startX + (endX - startX) * progress - 15;
        const newY = startY + (endY - startY) * progress - 15;
        
        arrow.style.left = newX + 'px';
        arrow.style.top = newY + 'px';
        
        if (Math.random() > 0.5) {
          const trail = document.createElement('div');
          trail.className = 'arrow-trail';
          trail.style.left = (newX + 7) + 'px';
          trail.style.top = (newY + 7) + 'px';
          canvas.appendChild(trail);
          setTimeout(() => trail.remove(), 500);
        }
      }, 20);
    }

    function completeGame3Level() {
      if (game3State.gameLoop) {
        clearInterval(game3State.gameLoop);
        game3State.gameLoop = null;
      }

      const levelBonus = game3State.level * 50;
      game3State.score += levelBonus;
      document.getElementById('game3-score').textContent = game3State.score;

      // L∆∞u ƒëi·ªÉm
      updateUserScore('game3', game3State.score, game3State.level, game3State.score);

      // Ph√°t √¢m thanh ho√†n th√†nh level
      SoundEffects.levelComplete();
      
      showLevelCompleteModal(
        game3State.level,
        levelBonus,
        game3State.questionsAnswered,
        () => {
          if (game3State.level >= 5) {
            showToast(`üéâ Ho√†n th√†nh! T·ªïng ƒëi·ªÉm: ${game3State.score}`, 'success');
            setTimeout(() => {
              showCertificate('B·∫£o V·ªá C·ª© ƒêi·ªÉm', game3State.score, 5);
            }, 1000);
          } else {
            game3State.level++;
            game3State.questionsAnswered = 0;
            game3State.lives = 3;
            
            document.getElementById('game3-level').textContent = game3State.level;
            document.getElementById('game3-kills').textContent = game3State.questionsAnswered;
            updateGame3Lives();
            
            const canvas = document.getElementById('game3-canvas');
            game3State.enemies.forEach(e => e.element.remove());
            game3State.enemies = [];
            
            nextQuestion3();
            game3State.gameLoop = setInterval(updateGame3, 50);
          }
        }
      );
    }

    function endGame3() {
      if (game3State.gameLoop) {
        clearInterval(game3State.gameLoop);
      }
      
      // L∆∞u ƒëi·ªÉm
      updateUserScore('game3', game3State.score, game3State.level, game3State.score);
      
      showToast(`Game k·∫øt th√∫c! ƒêi·ªÉm: ${game3State.score}`, 'success');
      setTimeout(() => backToMenu(), 1500);
    }

    // ========== GAME 4: N√îNG TR·∫†I S·ªê - S·ª¨A L·ªñI QUAN TR·ªåNG ==========
    function getPlotDisplay(stage) {
      const stages = [
        { icon: 'üü´', text: 'ƒê·∫•t tr·ªëng', bg: 'linear-gradient(135deg, #78350f 0%, #451a03 100%)', color: '#fef3c7', size: '48px' },
        { icon: 'üå∞', text: 'H·∫°t gi·ªëng', bg: 'linear-gradient(135deg, #65a30d 0%, #3f6212 100%)', color: '#ecfccb', size: '40px' },
        { icon: 'üå±', text: 'M·∫ßm non', bg: 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)', color: '#dcfce7', size: '52px' },
        { icon: 'üåø', text: 'C√¢y l·ªõn', bg: 'linear-gradient(135deg, #059669 0%, #047857 100%)', color: '#d1fae5', size: '56px' },
        { icon: 'üåæ', text: 'Ch√≠n r·ªô ‚ú®', bg: 'linear-gradient(135deg, #eab308 0%, #ca8a04 100%)', color: '#fef9c3', size: '60px' }
      ];
      return stages[stage] || stages[0];
    }

    function renderGame4() {
      const config = window.elementSdk?.config || defaultConfig;
      const bgColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const game4Name = config.game4_name || defaultConfig.game4_name;
      
      return `
        <div class="min-h-full p-3 sm:p-4" style="background: ${bgColor};">
          <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 mb-3 sm:mb-4">
              <div class="flex justify-between items-start sm:items-center mb-3 sm:mb-4">
                <div>
                  <h2 class="text-lg sm:text-2xl font-bold" style="color: ${textColor};">üë®‚Äçüåæ ${game4Name}</h2>
                  <p class="text-xs sm:text-sm text-gray-600 mt-1 hidden sm:block">Nh·∫•p √¥ ƒë·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi</p>
                </div>
                <div class="flex gap-2">
                  <button onclick="saveAndExit('game4')" class="px-3 sm:px-4 py-2 text-sm sm:text-base bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition" onclick="SoundEffects.buttonClick()">
                    üíæ L∆∞u & Tho√°t
                  </button>
                  <button onclick="backToMenu()" class="px-3 sm:px-4 py-2 text-sm sm:text-base bg-gray-200 rounded-lg font-medium hover:bg-gray-300 transition active:scale-95" onclick="SoundEffects.buttonClick()">
                    ‚Üê Menu
                  </button>
                </div>
              </div>
              <div class="grid grid-cols-3 gap-2 sm:gap-3">
                <div class="bg-blue-50 rounded-lg p-2 sm:p-3 text-center">
                  <div class="text-xs text-gray-600">Level</div>
                  <div class="text-lg sm:text-xl font-bold" style="color: ${primaryColor};"><span id="game4-level">${game4State.level}</span></div>
                </div>
                <div class="bg-green-50 rounded-lg p-2 sm:p-3 text-center">
                  <div class="text-xs text-gray-600">Thu ho·∫°ch</div>
                  <div class="text-lg sm:text-xl font-bold" style="color: ${textColor};"><span id="game4-harvest">${game4State.harvestCount}</span>/3</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-2 sm:p-3 text-center">
                  <div class="text-xs text-gray-600">ƒêi·ªÉm</div>
                  <div class="text-lg sm:text-xl font-bold" style="color: ${primaryColor};"><span id="game4-score">${game4State.totalScore}</span></div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-3 sm:mb-4">
              ${game4State.plots.map((plot, i) => {
                const plotInfo = getPlotDisplay(plot.stage);
                return `
                <div 
                  onclick="selectPlot(${i})" 
                  class="rounded-xl sm:rounded-2xl shadow-lg cursor-pointer hover:shadow-2xl transition transform active:scale-95 sm:hover:-translate-y-1 relative overflow-hidden"
                  style="height: 160px; background: ${plotInfo.bg};"
                  data-plot-index="${i}"
                >
                  <div class="plant-plot">
                    <div class="text-center mb-2" style="font-size: ${plotInfo.size}; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));">
                      <div class="${plot.stage === 4 ? 'sparkle' : ''}">${plotInfo.icon}</div>
                    </div>
                    <div class="text-sm sm:text-base font-bold text-center" style="color: ${plotInfo.color};">${plotInfo.text}</div>
                    ${plot.stage > 0 ? '<div class="absolute bottom-2 right-2 text-2xl sm:text-3xl">üë®‚Äçüåæ</div>' : ''}
                  </div>
                  ${plot.stage === 4 ? '<div class="absolute inset-0 flex items-center justify-center text-white text-xs sm:text-sm font-semibold opacity-0 active:opacity-100 sm:hover:opacity-100 transition bg-black bg-opacity-40 rounded-xl sm:rounded-2xl">Nh·∫•n ƒë·ªÉ thu ho·∫°ch</div>' : '<div class="absolute inset-0 flex items-center justify-center text-white text-xs sm:text-sm font-semibold opacity-0 active:opacity-100 sm:hover:opacity-100 transition bg-black bg-opacity-40 rounded-xl sm:rounded-2xl">Nh·∫•n ƒë·ªÉ tr·∫£ l·ªùi</div>'}
                </div>
              `}).join('')}
            </div>

            <div id="game4-question" class="bg-white rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6" style="display: none;">
              <h3 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 text-center" style="color: ${textColor};" id="q-text"></h3>
              <div class="grid grid-cols-2 gap-2 sm:gap-3" id="q-answers"></div>
            </div>

            <div class="bg-blue-50 rounded-lg sm:rounded-xl p-3 sm:p-4 text-center text-xs sm:text-sm text-gray-700">
              <p>üí° <strong>H∆∞·ªõng d·∫´n:</strong> ƒê√∫ng ‚Üí C√¢y l·ªõn l√™n ‚Ä¢ Sai ‚Üí C√¢y l√πi l·∫°i</p>
            </div>
          </div>
        </div>
      `;
    }

    function selectPlot(plotIndex) {
      const plot = game4State.plots[plotIndex];
      
      if (plot.stage >= 4) {
        // Ph√°t √¢m thanh thu ho·∫°ch
        SoundEffects.harvest();
        
        const score = 50 + game4State.level * 10;
        game4State.totalScore += score;
        document.getElementById('game4-score').textContent = game4State.totalScore;
        
        game4State.harvestCount++;
        document.getElementById('game4-harvest').textContent = game4State.harvestCount;
        
        showToast(`üéâ Thu ho·∫°ch th√†nh c√¥ng! +${score} ƒëi·ªÉm`, 'success');
        plot.stage = 4;
        
        if (game4State.harvestCount >= 3) {
          completeGame4Level();
        } else {
          updatePlotDisplay(plotIndex);
        }
      } else {
        game4State.selectedPlot = plotIndex;
        showQuestion4();
      }
    }

    function showQuestion4() {
      const questionData = gameData.game4[Math.floor(Math.random() * gameData.game4.length)];
      game4State.currentQuestion = {
        question: questionData[0],
        correctAnswer: questionData[1],
        allAnswers: [questionData[1], ...questionData.slice(2).filter(a => a && a.trim())]
          .sort(() => Math.random() - 0.5)
          .slice(0, 4)
      };

      document.getElementById('q-text').textContent = game4State.currentQuestion.question;
      document.getElementById('q-answers').innerHTML = game4State.currentQuestion.allAnswers.map(answer => `
        <button 
          onclick="answerQuestion4('${answer.replace(/'/g, "\\'")}', this)" 
          class="py-2.5 sm:py-3 px-3 sm:px-4 text-sm sm:text-base bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition transform hover:scale-105 active:scale-95"
        >
          ${answer}
        </button>
      `).join('');

      document.getElementById('game4-question').style.display = 'block';
    }

    function answerQuestion4(answer, button) {
      const plotIndex = game4State.selectedPlot;
      const plot = game4State.plots[plotIndex];
      const plotElement = document.querySelector(`[data-plot-index="${plotIndex}"]`);

      button.classList.add('pulse');

      if (answer === game4State.currentQuestion.correctAnswer) {
        // Ph√°t √¢m thanh tr·∫£ l·ªùi ƒë√∫ng
        SoundEffects.correctAnswer();
        
        plot.stage = Math.min(4, plot.stage + 1);
        
        const messages = [
          'üå∞ ƒê√∫ng r·ªìi! H·∫°t gi·ªëng ƒë√£ n·∫£y m·∫ßm!',
          'üå± Tuy·ªát v·ªùi! M·∫ßm ƒëang l·ªõn l√™n!',
          'üåø Xu·∫•t s·∫Øc! C√¢y ƒëang ph√°t tri·ªÉn!',
          'üåæ Ho√†n h·∫£o! C√¢y ƒë√£ ch√≠n r·ªô!'
        ];
        
        // Ph√°t √¢m thanh c√¢y l·ªõn l√™n
        if (plot.stage === 1) {
          SoundEffects.plantSeed();
        } else if (plot.stage > 1) {
          SoundEffects.growPlant();
        }
        
        showToast(messages[Math.min(plot.stage - 1, 3)], 'success');
        
        setTimeout(() => {
          document.getElementById('game4-question').style.display = 'none';
          updatePlotDisplay(plotIndex);
        }, 500);
      } else {
        // Ph√°t √¢m thanh tr·∫£ l·ªùi sai
        SoundEffects.wrongAnswer();
        
        if (plot.stage > 0) {
          plot.stage = Math.max(0, plot.stage - 1);
          showToast('‚ùå Sai r·ªìi! C√¢y b·ªã h√©o l√πi l·∫°i 1 giai ƒëo·∫°n!', 'error');
          
          setTimeout(() => {
            document.getElementById('game4-question').style.display = 'none';
            updatePlotDisplay(plotIndex);
          }, 500);
        } else {
          showToast('‚ùå Sai r·ªìi! Th·ª≠ l·∫°i ƒë·ªÉ gieo h·∫°t nh√©!', 'error');
          setTimeout(() => button.classList.remove('pulse'), 300);
        }
      }
    }

    function updatePlotDisplay(plotIndex) {
      const plot = game4State.plots[plotIndex];
      const plotElement = document.querySelector(`[data-plot-index="${plotIndex}"]`);
      if (!plotElement) return;

      const plotInfo = getPlotDisplay(plot.stage);
      
      plotElement.style.background = plotInfo.bg;
      plotElement.innerHTML = `
        <div class="plant-plot">
          <div class="text-center mb-2" style="font-size: ${plotInfo.size}; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));">
            <div class="${plot.stage === 4 ? 'sparkle grow' : 'grow'}">${plotInfo.icon}</div>
          </div>
          <div class="text-sm sm:text-base font-bold text-center" style="color: ${plotInfo.color};">${plotInfo.text}</div>
          ${plot.stage > 0 ? '<div class="absolute bottom-2 right-2 text-2xl sm:text-3xl">üë®‚Äçüåæ</div>' : ''}
        </div>
        ${plot.stage === 4 ? '<div class="absolute inset-0 flex items-center justify-center text-white text-xs sm:text-sm font-semibold opacity-0 active:opacity-100 sm:hover:opacity-100 transition bg-black bg-opacity-40 rounded-xl sm:rounded-2xl">Nh·∫•n ƒë·ªÉ thu ho·∫°ch</div>' : '<div class="absolute inset-0 flex items-center justify-center text-white text-xs sm:text-sm font-semibold opacity-0 active:opacity-100 sm:hover:opacity-100 transition bg-black bg-opacity-40 rounded-xl sm:rounded-2xl">Nh·∫•n ƒë·ªÉ tr·∫£ l·ªùi</div>'}
      `;
    }

    function completeGame4Level() {
      const levelBonus = game4State.level * 50;
      game4State.totalScore += levelBonus;
      document.getElementById('game4-score').textContent = game4State.totalScore;

      // L∆∞u ƒëi·ªÉm
      updateUserScore('game4', game4State.totalScore, game4State.level, game4State.totalScore);

      // Ph√°t √¢m thanh ho√†n th√†nh level
      SoundEffects.levelComplete();
      
      showLevelCompleteModal(
        game4State.level,
        levelBonus,
        game4State.harvestCount,
        () => {
          if (game4State.level >= 5) {
            showToast(`üéâ Ho√†n th√†nh t·∫•t c·∫£! T·ªïng ƒëi·ªÉm: ${game4State.totalScore}`, 'success');
            setTimeout(() => {
              showCertificate('N√¥ng Tr·∫°i S·ªë', game4State.totalScore, 5);
            }, 1000);
          } else {
            game4State.level++;
            game4State.harvestCount = 0;
            
            document.getElementById('game4-level').textContent = game4State.level;
            document.getElementById('game4-harvest').textContent = game4State.harvestCount;
            
            game4State.plots.forEach(plot => {
              plot.stage = 0;
            });
            
            // QUAN TR·ªåNG: Ch·ªâ c·∫≠p nh·∫≠t UI, kh√¥ng g·ªçi render() ƒë·ªÉ kh√¥ng reset state
            updateGame4UI();
            updateAllPlotsDisplay();
          }
        }
      );
    }

    // ========== MODAL HO√ÄN TH√ÄNH LEVEL ==========
    function showLevelCompleteModal(level, score, stat, onNext) {
      const modal = document.createElement('div');
      modal.className = 'level-complete-modal';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl sm:rounded-3xl p-6 sm:p-8 max-w-sm sm:max-w-md mx-4 shadow-2xl transform scale-0" style="animation: scaleIn 0.3s ease-out forwards;">
          <div class="text-center">
            <div class="text-5xl sm:text-7xl mb-3 sm:mb-4">üéâ</div>
            <h3 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Level ${level} Ho√†n Th√†nh!</h3>
            <div class="text-4xl sm:text-5xl font-bold text-green-500 mb-3 sm:mb-4">+${score}</div>
            <div class="bg-gray-100 rounded-xl p-3 sm:p-4 mb-4 sm:mb-6">
              <p class="text-sm sm:text-base text-gray-600">Th√†nh t√≠ch: ${stat}</p>
            </div>
            <button 
              class="w-full py-3 bg-blue-500 text-white rounded-xl font-bold text-base sm:text-lg hover:bg-blue-600 transition active:scale-95"
              onclick="SoundEffects.buttonClick()"
            >
              ${level >= 5 ? 'üéä Ho√†n th√†nh t·∫•t c·∫£' : '‚û°Ô∏è Level ti·∫øp theo'}
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('button').onclick = () => {
        modal.remove();
        onNext();
      };
    }

    // ========== MODAL GAME OVER ==========
    function showGameOverModal(finalScore, level, onRestart, onMenu) {
      const modal = document.createElement('div');
      modal.className = 'level-complete-modal';
      modal.innerHTML = `
        <div class="bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl sm:rounded-3xl p-6 sm:p-8 max-w-sm sm:max-w-md mx-4 shadow-2xl transform scale-0 border-4 border-red-500" style="animation: scaleIn 0.3s ease-out forwards;">
          <div class="text-center">
            <div class="text-6xl sm:text-8xl mb-3 sm:mb-4 animate-pulse">üíÄ</div>
            <h3 class="text-3xl sm:text-4xl font-bold text-red-600 mb-2">GAME OVER!</h3>
            <p class="text-base sm:text-lg text-gray-700 mb-4">H·∫øt m·∫°ng r·ªìi b·∫°n ∆°i!</p>
            <div class="bg-white rounded-xl p-4 mb-4 shadow-inner">
              <div class="text-sm text-gray-600 mb-2">ƒêi·ªÉm ƒë·∫°t ƒë∆∞·ª£c</div>
              <div class="text-3xl sm:text-4xl font-bold text-orange-500">${finalScore}</div>
              <div class="text-xs sm:text-sm text-gray-500 mt-2">Level ${level}</div>
            </div>
            <div class="space-y-2 sm:space-y-3">
              <button 
                id="restart-btn"
                class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-bold text-base sm:text-lg hover:from-green-600 hover:to-emerald-600 transition active:scale-95 shadow-lg"
                onclick="SoundEffects.buttonClick()"
              >
                üîÑ Ch∆°i l·∫°i
              </button>
              <button 
                id="menu-btn"
                class="w-full py-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl font-bold text-base sm:text-lg hover:from-blue-600 hover:to-indigo-600 transition active:scale-95 shadow-lg"
                onclick="SoundEffects.buttonClick()"
              >
                üè† V·ªÅ Menu
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('#restart-btn').onclick = () => {
        modal.remove();
        onRestart();
      };
      modal.querySelector('#menu-btn').onclick = () => {
        modal.remove();
        onMenu();
      };
    }

    // ========== CH·ª®NG NH·∫¨N ==========
    function showCertificate(gameName, score, level) {
      saveCertificate(gameName, score, level);
      
      // Ph√°t √¢m thanh th√†nh t√≠ch
      SoundEffects.achievement();
      
      const config = window.elementSdk?.config || defaultConfig;
      const certTitle = config.certificate_title || defaultConfig.certificate_title;
      const certText = config.certificate_text || defaultConfig.certificate_text;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      
      const modal = document.createElement('div');
      modal.className = 'level-complete-modal';
      modal.innerHTML = `
        <div class="certificate-container bg-white rounded-3xl p-8 max-w-3xl mx-4 shadow-2xl border-8 border-amber-400" id="certificate-content">
          <div class="text-center relative">
            <!-- D·∫•u m·ªôc/con d·∫•u g√≥c ph·∫£i -->
            <div class="certificate-seal absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-red-600 to-red-800 rounded-full flex items-center justify-center transform rotate-12 shadow-lg border-4 border-red-900">
              <div class="text-center">
                <div class="text-2xl">üèÜ</div>
                <div class="text-xs text-white font-bold">XU·∫§T S·∫ÆC</div>
              </div>
            </div>

            <!-- Header v·ªõi vi·ªÅn trang tr√≠ -->
            <div class="mb-6 pb-4 border-b-4 border-amber-400">
              <div class="text-6xl mb-3">üéì</div>
              <h2 class="text-4xl font-bold mb-2" style="color: ${textColor};">${certTitle}</h2>
              <div class="flex items-center justify-center gap-3 text-amber-600">
                <div class="w-16 h-1 bg-amber-400"></div>
                <div class="text-2xl">‚ú¶</div>
                <div class="w-16 h-1 bg-amber-400"></div>
              </div>
            </div>

            <!-- N·ªôi dung ch√≠nh -->
            <div class="mb-6">
              <p class="text-lg text-gray-700 mb-4">${certText}</p>
              <div class="text-5xl font-bold mb-3" style="color: ${primaryColor};">${gameName}</div>
              <p class="text-xl text-gray-600 mb-4">ƒê∆∞·ª£c trao cho</p>
              <div class="certificate-signature text-amber-900 mb-2">${currentUser.name}</div>
              <p class="text-sm text-gray-500 italic">V√¨ ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc ${level} c·∫•p ƒë·ªô</p>
            </div>

            <!-- Th√¥ng tin ƒëi·ªÉm -->
            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 rounded-xl p-6 mb-6 border-2 border-amber-200">
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <div class="text-xs text-gray-600 mb-1">T·ªïng ƒëi·ªÉm</div>
                  <div class="text-3xl font-bold text-amber-600">${score}</div>
                </div>
                <div>
                  <div class="text-xs text-gray-600 mb-1">C·∫•p ƒë·ªô</div>
                  <div class="text-3xl font-bold text-amber-600">${level}/5</div>
                </div>
                <div>
                  <div class="text-xs text-gray-600 mb-1">Ng√†y</div>
                  <div class="text-sm font-bold text-amber-600">${new Date().toLocaleDateString('vi-VN')}</div>
                </div>
              </div>
            </div>

            <!-- Ch·ªØ k√Ω v√† d·∫•u -->
            <div class="flex justify-between items-end mb-6 px-8">
              <div class="text-center">
                <div class="text-sm text-gray-500 mb-2">Gi·∫£ng vi√™n</div>
                <div class="certificate-signature text-2xl text-gray-800">H·ªá Th·ªëng</div>
                <div class="w-32 h-0.5 bg-gray-400 mx-auto"></div>
              </div>
              <div class="text-6xl opacity-20 transform -rotate-12">üèÖ</div>
            </div>

            <!-- Buttons -->
            <div class="space-y-3">
              <button 
                onclick="downloadCertificate()"
                class="w-full py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-white rounded-xl font-bold text-lg hover:from-amber-600 hover:to-yellow-600 transition shadow-lg active:scale-95"
                onclick="SoundEffects.buttonClick()"
              >
                üì• T·∫£i xu·ªëng ch·ª©ng nh·∫≠n
              </button>
              <button 
                onclick="closeCertificate()"
                class="w-full py-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl font-bold text-lg hover:from-blue-600 hover:to-indigo-600 transition shadow-lg active:scale-95"
                onclick="SoundEffects.buttonClick()"
              >
                ‚úÖ ƒê√≥ng
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function viewCertificate(index) {
      const cert = currentUser.certificates[index];
      const config = window.elementSdk?.config || defaultConfig;
      const certTitle = config.certificate_title || defaultConfig.certificate_title;
      const certText = config.certificate_text || defaultConfig.certificate_text;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      
      const modal = document.createElement('div');
      modal.className = 'level-complete-modal';
      modal.innerHTML = `
        <div class="certificate-container bg-white rounded-3xl p-8 max-w-3xl mx-4 shadow-2xl border-8 border-amber-400" id="certificate-content">
          <div class="text-center relative">
            <div class="certificate-seal absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-red-600 to-red-800 rounded-full flex items-center justify-center transform rotate-12 shadow-lg border-4 border-red-900">
              <div class="text-center">
                <div class="text-2xl">üèÜ</div>
                <div class="text-xs text-white font-bold">XU·∫§T S·∫ÆC</div>
              </div>
            </div>

            <div class="mb-6 pb-4 border-b-4 border-amber-400">
              <div class="text-6xl mb-3">üéì</div>
              <h2 class="text-4xl font-bold mb-2" style="color: ${textColor};">${certTitle}</h2>
              <div class="flex items-center justify-center gap-3 text-amber-600">
                <div class="w-16 h-1 bg-amber-400"></div>
                <div class="text-2xl">‚ú¶</div>
                <div class="w-16 h-1 bg-amber-400"></div>
              </div>
            </div>

            <div class="mb-6">
              <p class="text-lg text-gray-700 mb-4">${certText}</p>
              <div class="text-5xl font-bold mb-3" style="color: ${primaryColor};">${cert.gameName}</div>
              <p class="text-xl text-gray-600 mb-4">ƒê∆∞·ª£c trao cho</p>
              <div class="certificate-signature text-amber-900 mb-2">${currentUser.name}</div>
              <p class="text-sm text-gray-500 italic">V√¨ ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc ${cert.level} c·∫•p ƒë·ªô</p>
            </div>

            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 rounded-xl p-6 mb-6 border-2 border-amber-200">
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <div class="text-xs text-gray-600 mb-1">T·ªïng ƒëi·ªÉm</div>
                  <div class="text-3xl font-bold text-amber-600">${cert.score}</div>
                </div>
                <div>
                  <div class="text-xs text-gray-600 mb-1">C·∫•p ƒë·ªô</div>
                  <div class="text-3xl font-bold text-amber-600">${cert.level}/5</div>
                </div>
                <div>
                  <div class="text-xs text-gray-600 mb-1">Ng√†y</div>
                  <div class="text-sm font-bold text-amber-600">${cert.date}</div>
                </div>
              </div>
            </div>

            <div class="flex justify-between items-end mb-6 px-8">
              <div class="text-center">
                <div class="text-sm text-gray-500 mb-2">Gi·∫£ng vi√™n</div>
                <div class="certificate-signature text-2xl text-gray-800">H·ªá Th·ªëng</div>
                <div class="w-32 h-0.5 bg-gray-400 mx-auto"></div>
              </div>
              <div class="text-6xl opacity-20 transform -rotate-12">üèÖ</div>
            </div>

            <div class="space-y-3">
              <button 
                onclick="downloadCertificate()"
                class="w-full py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-white rounded-xl font-bold text-lg hover:from-amber-600 hover:to-yellow-600 transition shadow-lg active:scale-95"
                onclick="SoundEffects.buttonClick()"
              >
                üì• T·∫£i xu·ªëng ch·ª©ng nh·∫≠n
              </button>
              <button 
                onclick="closeCertificate()"
                class="w-full py-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl font-bold text-lg hover:from-blue-600 hover:to-indigo-600 transition shadow-lg active:scale-95"
                onclick="SoundEffects.buttonClick()"
              >
                ‚úÖ ƒê√≥ng
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function downloadCertificate() {
      const certificate = document.getElementById('certificate-content');
      if (!certificate) return;

      // Ph√°t √¢m thanh t·∫£i xu·ªëng
      SoundEffects.buttonClick();
      
      // S·ª≠ d·ª•ng html2canvas ƒë·ªÉ ch·ª•p m√†n h√¨nh ch·ª©ng nh·∫≠n
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      script.onload = () => {
        window.html2canvas(certificate, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false
        }).then(canvas => {
          // Chuy·ªÉn canvas th√†nh blob
          canvas.toBlob(blob => {
            // T·∫°o URL t·ª´ blob
            const url = URL.createObjectURL(blob);
            
            // T·∫°o link download
            const link = document.createElement('a');
            link.download = `Chung-Nhan-${currentUser.name}-${Date.now()}.png`;
            link.href = url;
            link.click();
            
            // D·ªçn d·∫πp
            URL.revokeObjectURL(url);
            showToast('‚úÖ ƒê√£ t·∫£i xu·ªëng ch·ª©ng nh·∫≠n!', 'success');
          });
        });
      };
      document.head.appendChild(script);
    }

    function closeCertificate() {
      const modal = document.querySelector('.level-complete-modal');
      if (modal) modal.remove();
      backToMenu();
    }

    // ========== NAVIGATION ==========
    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      if (!username) {
        showToast('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n', 'error');
        return;
      }
      // Ph√°t √¢m thanh ƒëƒÉng nh·∫≠p
      SoundEffects.buttonClick();
      saveUser(username);
      currentScreen = 'menu';
      render();
    }

    function backToMenu() {
      // D·ª´ng auto-save
      stopAutoSave();
      
      if (game2State.gameLoop) {
        clearInterval(game2State.gameLoop);
        document.removeEventListener('mousemove', handleGame2Mouse);
        document.removeEventListener('touchmove', handleGame2Touch);
        document.removeEventListener('keydown', handleGame2Keys);
      }
      if (game3State.gameLoop) {
        clearInterval(game3State.gameLoop);
      }
      currentScreen = 'menu';
      render();
    }

    function logout() {
      // D·ª´ng auto-save
      stopAutoSave();
      
      localStorage.removeItem('xedang_current_user');
      currentUser = null;
      currentScreen = 'login';
      render();
    }

    function showLeaderboard() {
      currentScreen = 'leaderboard';
      render();
    }

    function showCertificatesList() {
      currentScreen = 'certificates';
      render();
    }

    function showBadges() {
      currentScreen = 'badges';
      render();
    }

    function startGame(gameId) {
      currentScreen = gameId;
      // QUAN TR·ªåNG: Khi v√†o game t·ª´ menu, ƒë√°nh d·∫•u game 4 ch∆∞a kh·ªüi t·∫°o
      if (gameId === 'game4') {
        isGame4Initialized = false;
      }
      render();
    }

    // ========== ELEMENT SDK ==========
    async function onConfigChange(config) {
      render();
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig: defaultConfig,
        onConfigChange: onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                window.elementSdk.config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.secondary_color || defaultConfig.secondary_color,
              set: (value) => {
                window.elementSdk.config.secondary_color = value;
                window.elementSdk.setConfig({ secondary_color: value });
              }
            },
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                window.elementSdk.config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                window.elementSdk.config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.success_color || defaultConfig.success_color,
              set: (value) => {
                window.elementSdk.config.success_color = value;
                window.elementSdk.setConfig({ success_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['app_title', config.app_title || defaultConfig.app_title],
          ['welcome_message', config.welcome_message || defaultConfig.welcome_message],
          ['game1_name', config.game1_name || defaultConfig.game1_name],
          ['game2_name', config.game2_name || defaultConfig.game2_name],
          ['game3_name', config.game3_name || defaultConfig.game3_name],
          ['game4_name', config.game4_name || defaultConfig.game4_name],
          ['certificate_title', config.certificate_title || defaultConfig.certificate_title],
          ['certificate_text', config.certificate_text || defaultConfig.certificate_text]
        ])
      });
    }

    // ========== KH·ªûI ƒê·ªòNG ·ª®NG D·ª§NG ==========
    window.addEventListener('DOMContentLoaded', async function() {
      try {
        // Kh·ªüi t·∫°o h·ªá th·ªëng √¢m thanh
        initAudio();
        
        // T·∫£i c·∫•u h√¨nh ƒë·ªìng b·ªô
        loadSyncConfig();
        
        await fetchData();
        
        // ƒê·ªìng b·ªô ƒëi·ªÉm ƒëang ch·ªù n·∫øu c√≥ m·∫°ng
        if (isOnline) {
          syncPendingScores();
        }
        
        if (loadUser()) {
          currentScreen = 'menu';
        } else {
          currentScreen = 'login';
        }
        
        render();
        updateOfflineIndicator();
        
        // Th√™m s·ª± ki·ªán cho n√∫t ƒëi·ªÅu khi·ªÉn √¢m thanh
        document.getElementById('bgm-toggle')?.addEventListener('click', toggleBGM);
        document.getElementById('sfx-toggle')?.addEventListener('click', toggleSFX);
        
      } catch (error) {
        console.error('Init error:', error);
        currentScreen = 'login';
        render();
      }
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b37d4e405924625',t:'MTc2NjY2MDM5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
